---
phase: 01-authentication
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - components/ui/sidebar.tsx
  - components/ui/sheet.tsx
  - components/ui/tooltip.tsx
  - components/ui/skeleton.tsx
  - hooks/use-mobile.tsx
  - components/app-sidebar.tsx
  - app/(dashboard)/layout.tsx
  - app/(dashboard)/dashboard/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can access dashboard at /dashboard after login"
    - "Unauthenticated users are redirected to /login"
    - "Dashboard has sidebar navigation"
    - "Sidebar shows user email and logout button"
    - "Dashboard page displays welcome message with user email"
  artifacts:
    - path: "components/ui/sidebar.tsx"
      provides: "shadcn sidebar primitives"
      min_lines: 100
    - path: "components/app-sidebar.tsx"
      provides: "Application sidebar with nav and user section"
      min_lines: 30
    - path: "app/(dashboard)/layout.tsx"
      provides: "Dashboard layout with auth check and sidebar"
      min_lines: 20
    - path: "app/(dashboard)/dashboard/page.tsx"
      provides: "Dashboard home page"
      min_lines: 15
  key_links:
    - from: "app/(dashboard)/layout.tsx"
      to: "lib/supabase/server.ts"
      via: "createClient for auth check"
      pattern: "getUser\\(\\)"
    - from: "app/(dashboard)/dashboard/page.tsx"
      to: "lib/supabase/server.ts"
      via: "createClient for user data"
      pattern: "getUser\\(\\)"
    - from: "components/app-sidebar.tsx"
      to: "components/logout-button.tsx"
      via: "LogoutButton import"
      pattern: "import.*LogoutButton"
---

<objective>
Create the protected dashboard area with sidebar layout and auth protection.

Purpose: Provides the authenticated user experience with navigation sidebar. Completes the auth flow by giving users somewhere to land after login.
Output: Working /dashboard route that redirects unauthenticated users and displays sidebar layout for authenticated users.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-authentication/01-RESEARCH.md
@.planning/phases/01-authentication/01-01-SUMMARY.md
@.planning/phases/01-authentication/01-02-SUMMARY.md

Dependencies from prior plans:
- lib/actions/auth.ts - logout action
- components/logout-button.tsx - LogoutButton component

Existing infrastructure:
- lib/supabase/server.ts - createClient() returns Supabase client
- shadcn/ui components already installed: button, input, label, card, separator
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn sidebar component</name>
  <files>
    components/ui/sidebar.tsx
    components/ui/sheet.tsx
    components/ui/tooltip.tsx
    components/ui/skeleton.tsx
    hooks/use-mobile.tsx
  </files>
  <action>
Run shadcn CLI to install sidebar and its dependencies:

```bash
npx shadcn@latest add sidebar --yes
```

This installs:
- components/ui/sidebar.tsx - Core sidebar primitives (SidebarProvider, Sidebar, SidebarContent, SidebarTrigger, etc.)
- components/ui/sheet.tsx - Sheet component (sidebar dependency for mobile)
- components/ui/tooltip.tsx - Tooltip component (sidebar dependency)
- components/ui/skeleton.tsx - Skeleton component (loading states)
- hooks/use-mobile.tsx - Mobile detection hook

The --yes flag accepts defaults without prompting.

Verify installation:
```bash
ls -la components/ui/sidebar.tsx hooks/use-mobile.tsx
```
  </action>
  <verify>
```bash
test -f components/ui/sidebar.tsx && grep "SidebarProvider" components/ui/sidebar.tsx
```
  </verify>
  <done>shadcn sidebar component and dependencies installed</done>
</task>

<task type="auto">
  <name>Task 2: Create app sidebar component</name>
  <files>components/app-sidebar.tsx</files>
  <action>
Create components/app-sidebar.tsx - the application's sidebar with navigation and user section.

```typescript
import { User } from '@supabase/supabase-js'
import {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarMenu,
  SidebarMenuButton,
  SidebarMenuItem,
} from '@/components/ui/sidebar'
import { LogoutButton } from '@/components/logout-button'
import { LayoutDashboard, Users, FileText } from 'lucide-react'
import Link from 'next/link'

const navItems = [
  { title: 'Dashboard', href: '/dashboard', icon: LayoutDashboard },
  { title: 'Clients', href: '/clients', icon: Users },
  { title: 'Reports', href: '/reports', icon: FileText },
]

export function AppSidebar({ user }: { user: User }) {
  return (
    <Sidebar>
      <SidebarHeader className="border-b p-4">
        <span className="font-semibold text-lg">Rothc</span>
      </SidebarHeader>
      <SidebarContent>
        <SidebarGroup>
          <SidebarGroupLabel>Navigation</SidebarGroupLabel>
          <SidebarGroupContent>
            <SidebarMenu>
              {navItems.map((item) => (
                <SidebarMenuItem key={item.title}>
                  <SidebarMenuButton asChild>
                    <Link href={item.href}>
                      <item.icon className="size-4" />
                      <span>{item.title}</span>
                    </Link>
                  </SidebarMenuButton>
                </SidebarMenuItem>
              ))}
            </SidebarMenu>
          </SidebarGroupContent>
        </SidebarGroup>
      </SidebarContent>
      <SidebarFooter className="border-t p-4">
        <div className="flex flex-col gap-2">
          <span className="text-sm text-muted-foreground truncate">
            {user.email}
          </span>
          <LogoutButton />
        </div>
      </SidebarFooter>
    </Sidebar>
  )
}
```

Key points:
- Receives User prop to display email
- Navigation links for future pages (Clients, Reports - will 404 for now, that's fine)
- Footer shows user email and LogoutButton
- Uses Lucide icons already installed
  </action>
  <verify>
```bash
test -f components/app-sidebar.tsx && grep "export function AppSidebar" components/app-sidebar.tsx
```
  </verify>
  <done>AppSidebar component created with navigation and user section</done>
</task>

<task type="auto">
  <name>Task 3: Create dashboard layout and page</name>
  <files>
    app/(dashboard)/layout.tsx
    app/(dashboard)/dashboard/page.tsx
  </files>
  <action>
Create app/(dashboard)/layout.tsx - protected layout with sidebar:

```typescript
import { cookies } from 'next/headers'
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import { SidebarProvider, SidebarTrigger } from '@/components/ui/sidebar'
import { AppSidebar } from '@/components/app-sidebar'

export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const supabase = await createClient()
  const { data: { user }, error } = await supabase.auth.getUser()

  if (error || !user) {
    redirect('/login')
  }

  const cookieStore = await cookies()
  const defaultOpen = cookieStore.get('sidebar_state')?.value === 'true'

  return (
    <SidebarProvider defaultOpen={defaultOpen}>
      <AppSidebar user={user} />
      <main className="flex-1 flex flex-col">
        <header className="border-b p-4 flex items-center gap-4">
          <SidebarTrigger />
        </header>
        <div className="flex-1 p-6">
          {children}
        </div>
      </main>
    </SidebarProvider>
  )
}
```

Create app/(dashboard)/dashboard/page.tsx - dashboard home:

```typescript
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'

export default async function DashboardPage() {
  const supabase = await createClient()
  const { data: { user }, error } = await supabase.auth.getUser()

  if (error || !user) {
    redirect('/login')
  }

  return (
    <div>
      <h1 className="text-2xl font-bold mb-4">Dashboard</h1>
      <p className="text-muted-foreground">
        Welcome, {user.email}
      </p>
    </div>
  )
}
```

CRITICAL: Both layout AND page check auth with getUser() (not getSession()).
- Layout check: For initial load
- Page check: For soft navigations (layouts don't re-run due to Partial Rendering)
  </action>
  <verify>
```bash
test -f app/\(dashboard\)/layout.tsx && grep "getUser" app/\(dashboard\)/layout.tsx && \
test -f app/\(dashboard\)/dashboard/page.tsx && grep "getUser" app/\(dashboard\)/dashboard/page.tsx
```
  </verify>
  <done>Dashboard layout with sidebar and page with welcome message created</done>
</task>

</tasks>

<verification>
All files exist:
```bash
ls -la components/ui/sidebar.tsx components/app-sidebar.tsx app/\(dashboard\)/layout.tsx app/\(dashboard\)/dashboard/page.tsx
```

TypeScript compiles:
```bash
npm run build 2>&1 | tail -20
```

Manual verification needed for full auth flow.
</verification>

<success_criteria>
- shadcn sidebar component installed with dependencies
- AppSidebar shows navigation, user email, and logout button
- /dashboard redirects to /login when not authenticated
- /dashboard shows sidebar and welcome message when authenticated
- Auth checked with getUser() in both layout and page
</success_criteria>

<checkpoint type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete authentication flow: login, signup, OAuth, magic link, protected dashboard</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Visit http://localhost:3000/dashboard - should redirect to /login
3. Click "Sign up" link, create account with email/password
4. Check email for confirmation (or check Supabase dashboard > Authentication > Users)
5. After confirmation, login with credentials
6. Verify dashboard shows with sidebar, your email, and logout button
7. Click "Sign Out" - should return to login page
8. Visit /dashboard again - should redirect to /login

Optional (if Google OAuth configured in Supabase):
- Test "Continue with Google" button
- Verify redirect flow works
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the auth flow</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/01-authentication/01-03-SUMMARY.md`
</output>
