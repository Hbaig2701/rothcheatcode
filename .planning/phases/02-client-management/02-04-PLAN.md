---
phase: 02
plan: 04
wave: 3
title: Clients List Page with Data Table
depends_on: ["02-02", "02-03"]
files_modified:
  - app/(dashboard)/clients/page.tsx
  - components/clients/client-columns.tsx
  - components/clients/clients-table.tsx
  - components/clients/clients-empty-state.tsx
autonomous: true
estimated_tasks: 3

must_haves:
  truths:
    - "User can see a list of their clients in a data table"
    - "Table has sortable columns (name, state, filing status, created date)"
    - "User can search/filter clients by name"
    - "Table shows empty state when no clients exist"
    - "User can navigate to create new client"
    - "Row actions allow viewing, editing, and deleting clients"
  artifacts:
    - path: "app/(dashboard)/clients/page.tsx"
      provides: "Clients list page"
    - path: "components/clients/client-columns.tsx"
      provides: "TanStack Table column definitions"
      exports: ["columns"]
    - path: "components/clients/clients-table.tsx"
      provides: "Data table component with search and pagination"
      exports: ["ClientsTable"]
    - path: "components/clients/clients-empty-state.tsx"
      provides: "Empty state UI for no clients"
      exports: ["ClientsEmptyState"]
  key_links:
    - from: "app/(dashboard)/clients/page.tsx"
      to: "components/clients/clients-table.tsx"
      via: "ClientsTable component"
      pattern: "ClientsTable"
    - from: "components/clients/clients-table.tsx"
      to: "lib/queries/clients.ts"
      via: "useClients hook"
      pattern: "useClients"
---

# Clients List Page with Data Table

## Objective
Build the clients list page with a TanStack Table data table featuring sorting, filtering, and row actions.

## Tasks

<task id="1">
<title>Create column definitions and empty state component</title>
<action>
**Step 1:** Create `components/clients/clients-empty-state.tsx`:

```typescript
"use client";

import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Users } from "lucide-react";
import Link from "next/link";

export function ClientsEmptyState() {
  return (
    <Card className="border-dashed">
      <CardContent className="flex flex-col items-center justify-center py-12">
        <div className="rounded-full bg-muted p-3 mb-4">
          <Users className="h-6 w-6 text-muted-foreground" />
        </div>
        <h3 className="text-lg font-semibold mb-1">No clients yet</h3>
        <p className="text-muted-foreground text-center mb-4 max-w-sm">
          Get started by adding your first client to begin planning their Roth conversions.
        </p>
        <Button asChild>
          <Link href="/clients/new">Add your first client</Link>
        </Button>
      </CardContent>
    </Card>
  );
}
```

**Step 2:** Create `components/clients/client-columns.tsx`:

```typescript
"use client";

import { ColumnDef } from "@tanstack/react-table";
import { MoreHorizontal, ArrowUpDown } from "lucide-react";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import Link from "next/link";
import type { Client } from "@/lib/types/client";

// Helper to format filing status for display
const formatFilingStatus = (status: Client["filing_status"]): string => {
  const map: Record<Client["filing_status"], string> = {
    single: "Single",
    married_filing_jointly: "Married Filing Jointly",
    married_filing_separately: "Married Filing Separately",
    head_of_household: "Head of Household",
  };
  return map[status];
};

// CRITICAL: Define columns outside of component to prevent infinite re-renders
// If you need dynamic data (like onDelete callback), use a factory function
export const createColumns = (onDelete: (id: string) => void): ColumnDef<Client>[] => [
  {
    accessorKey: "name",
    header: ({ column }) => (
      <Button
        variant="ghost"
        onClick={() => column.toggleSorting(column.getIsSorted() === "asc")}
      >
        Name
        <ArrowUpDown className="ml-2 h-4 w-4" />
      </Button>
    ),
    cell: ({ row }) => (
      <Link
        href={`/clients/${row.original.id}`}
        className="font-medium hover:underline"
      >
        {row.getValue("name")}
      </Link>
    ),
  },
  {
    accessorKey: "state",
    header: "State",
  },
  {
    accessorKey: "filing_status",
    header: "Filing Status",
    cell: ({ row }) => formatFilingStatus(row.getValue("filing_status")),
  },
  {
    accessorKey: "created_at",
    header: ({ column }) => (
      <Button
        variant="ghost"
        onClick={() => column.toggleSorting(column.getIsSorted() === "asc")}
      >
        Created
        <ArrowUpDown className="ml-2 h-4 w-4" />
      </Button>
    ),
    cell: ({ row }) => {
      const date = new Date(row.getValue("created_at"));
      return date.toLocaleDateString();
    },
  },
  {
    id: "actions",
    cell: ({ row }) => {
      const client = row.original;
      return (
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" className="h-8 w-8 p-0">
              <span className="sr-only">Open menu</span>
              <MoreHorizontal className="h-4 w-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuItem asChild>
              <Link href={`/clients/${client.id}`}>View details</Link>
            </DropdownMenuItem>
            <DropdownMenuItem asChild>
              <Link href={`/clients/${client.id}/edit`}>Edit</Link>
            </DropdownMenuItem>
            <DropdownMenuSeparator />
            <DropdownMenuItem
              className="text-red-600 focus:text-red-600"
              onClick={() => onDelete(client.id)}
            >
              Delete
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      );
    },
  },
];
```

**KEY PATTERN:** Column definitions are in a factory function to accept `onDelete` callback while still being defined outside render. This prevents infinite re-renders with TanStack Table.
</action>
<verify>
1. Run `npx tsc --noEmit` - no type errors
2. Verify files exist:
   ```bash
   ls components/clients/clients-empty-state.tsx components/clients/client-columns.tsx
   ```
</verify>
</task>

<task id="2" depends_on="1">
<title>Create ClientsTable component with search and pagination</title>
<action>
Create `components/clients/clients-table.tsx`:

```typescript
"use client";

import { useState, useMemo } from "react";
import {
  useReactTable,
  getCoreRowModel,
  getFilteredRowModel,
  getPaginationRowModel,
  getSortedRowModel,
  flexRender,
  type SortingState,
  type ColumnFiltersState,
} from "@tanstack/react-table";
import { createColumns } from "./client-columns";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import type { Client } from "@/lib/types/client";
import { useDeleteClient } from "@/lib/queries/clients";

interface ClientsTableProps {
  data: Client[];
}

export function ClientsTable({ data }: ClientsTableProps) {
  const [sorting, setSorting] = useState<SortingState>([]);
  const [columnFilters, setColumnFilters] = useState<ColumnFiltersState>([]);
  const [deleteId, setDeleteId] = useState<string | null>(null);

  const deleteClient = useDeleteClient();

  // Memoize columns to prevent infinite re-renders
  const columns = useMemo(
    () => createColumns((id) => setDeleteId(id)),
    []
  );

  const table = useReactTable({
    data,
    columns,
    getCoreRowModel: getCoreRowModel(),
    getPaginationRowModel: getPaginationRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
    onSortingChange: setSorting,
    onColumnFiltersChange: setColumnFilters,
    state: {
      sorting,
      columnFilters,
    },
  });

  const handleDelete = async () => {
    if (!deleteId) return;
    try {
      await deleteClient.mutateAsync(deleteId);
    } catch (error) {
      // Error is handled by mutation - could add toast notification here
      console.error("Failed to delete client:", error);
    } finally {
      setDeleteId(null);
    }
  };

  return (
    <div className="space-y-4">
      {/* Search input */}
      <div className="flex items-center gap-2">
        <Input
          placeholder="Search clients by name..."
          value={(table.getColumn("name")?.getFilterValue() as string) ?? ""}
          onChange={(event) =>
            table.getColumn("name")?.setFilterValue(event.target.value)
          }
          className="max-w-sm"
        />
      </div>

      {/* Data table */}
      <div className="rounded-md border">
        <Table>
          <TableHeader>
            {table.getHeaderGroups().map((headerGroup) => (
              <TableRow key={headerGroup.id}>
                {headerGroup.headers.map((header) => (
                  <TableHead key={header.id}>
                    {header.isPlaceholder
                      ? null
                      : flexRender(
                          header.column.columnDef.header,
                          header.getContext()
                        )}
                  </TableHead>
                ))}
              </TableRow>
            ))}
          </TableHeader>
          <TableBody>
            {table.getRowModel().rows?.length ? (
              table.getRowModel().rows.map((row) => (
                <TableRow key={row.id}>
                  {row.getVisibleCells().map((cell) => (
                    <TableCell key={cell.id}>
                      {flexRender(
                        cell.column.columnDef.cell,
                        cell.getContext()
                      )}
                    </TableCell>
                  ))}
                </TableRow>
              ))
            ) : (
              <TableRow>
                <TableCell
                  colSpan={columns.length}
                  className="h-24 text-center"
                >
                  No results found.
                </TableCell>
              </TableRow>
            )}
          </TableBody>
        </Table>
      </div>

      {/* Pagination */}
      <div className="flex items-center justify-between">
        <p className="text-sm text-muted-foreground">
          {table.getFilteredRowModel().rows.length} client(s) total
        </p>
        <div className="flex items-center space-x-2">
          <Button
            variant="outline"
            size="sm"
            onClick={() => table.previousPage()}
            disabled={!table.getCanPreviousPage()}
          >
            Previous
          </Button>
          <Button
            variant="outline"
            size="sm"
            onClick={() => table.nextPage()}
            disabled={!table.getCanNextPage()}
          >
            Next
          </Button>
        </div>
      </div>

      {/* Delete confirmation dialog */}
      <AlertDialog open={!!deleteId} onOpenChange={() => setDeleteId(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Delete client?</AlertDialogTitle>
            <AlertDialogDescription>
              This action cannot be undone. This will permanently delete the
              client and all their associated data.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancel</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDelete}
              className="bg-red-600 hover:bg-red-700"
              disabled={deleteClient.isPending}
            >
              {deleteClient.isPending ? "Deleting..." : "Delete"}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}
```

**KEY PATTERNS:**
- `useMemo` for columns prevents infinite re-renders
- AlertDialog for delete confirmation
- `useDeleteClient` mutation from our hooks
- Search filters by "name" column
- Shows filtered count and pagination
</action>
<verify>
1. Run `npx tsc --noEmit` - no type errors
2. Verify file exists: `ls components/clients/clients-table.tsx`
</verify>
</task>

<task id="3" depends_on="2">
<title>Create clients list page</title>
<action>
Create `app/(dashboard)/clients/page.tsx`:

```typescript
"use client";

import { useClients } from "@/lib/queries/clients";
import { ClientsTable } from "@/components/clients/clients-table";
import { ClientsEmptyState } from "@/components/clients/clients-empty-state";
import { Button } from "@/components/ui/button";
import { Plus, Loader2 } from "lucide-react";
import Link from "next/link";

export default function ClientsPage() {
  const { data: clients, isLoading, isError, error } = useClients();

  if (isLoading) {
    return (
      <div className="container py-8">
        <div className="flex items-center justify-center h-64">
          <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
        </div>
      </div>
    );
  }

  if (isError) {
    return (
      <div className="container py-8">
        <div className="flex flex-col items-center justify-center h-64 text-center">
          <h2 className="text-lg font-semibold text-red-600 mb-2">
            Failed to load clients
          </h2>
          <p className="text-muted-foreground mb-4">
            {error?.message || "An unexpected error occurred"}
          </p>
          <Button variant="outline" onClick={() => window.location.reload()}>
            Try again
          </Button>
        </div>
      </div>
    );
  }

  const hasClients = clients && clients.length > 0;

  return (
    <div className="container py-8">
      {/* Page header */}
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Clients</h1>
          <p className="text-muted-foreground">
            Manage your clients and their Roth conversion projections.
          </p>
        </div>
        {hasClients && (
          <Button asChild>
            <Link href="/clients/new">
              <Plus className="mr-2 h-4 w-4" />
              Add client
            </Link>
          </Button>
        )}
      </div>

      {/* Content */}
      {hasClients ? (
        <ClientsTable data={clients} />
      ) : (
        <ClientsEmptyState />
      )}
    </div>
  );
}
```

**NOTE:** This page is a Client Component because it uses `useClients()` hook. For better performance in the future, consider prefetching data in a Server Component wrapper.
</action>
<verify>
1. Run `npx tsc --noEmit` - no type errors
2. Run `npm run dev` and navigate to http://localhost:3000/clients
   - Should show loading state briefly
   - If logged in: should show empty state or client list
   - If not logged in: should show error (401 from API)
</verify>
</task>

## Verification

After completing all tasks:

1. **Type checking passes:**
   ```bash
   npx tsc --noEmit
   ```

2. **Files exist:**
   ```bash
   ls app/\(dashboard\)/clients/page.tsx components/clients/
   ```

3. **Page loads:**
   - Navigate to http://localhost:3000/clients
   - Should see loading spinner, then content

4. **Table features work (when clients exist):**
   - [ ] Columns display correctly
   - [ ] Sorting works on Name and Created columns
   - [ ] Search filters by name
   - [ ] Pagination shows correct count
   - [ ] Row actions dropdown opens

5. **Empty state shows (when no clients):**
   - [ ] Shows "No clients yet" message
   - [ ] Has "Add your first client" button

## Rollback

If this plan fails:
1. Remove page: `rm -rf app/\(dashboard\)/clients`
2. Remove components: `rm -rf components/clients`
3. Previous plans' work remains intact
