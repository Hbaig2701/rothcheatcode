---
phase: 02
plan: 01
wave: 1
title: Foundation - Dependencies, Types, and Query Provider
depends_on: []
files_modified:
  - package.json
  - lib/types/client.ts
  - lib/validations/client.ts
  - components/providers/query-provider.tsx
  - app/layout.tsx
  - components/ui/table.tsx
autonomous: true
estimated_tasks: 3

must_haves:
  truths:
    - "TanStack Query, react-hook-form, Zod, and TanStack Table are installed"
    - "QueryProvider wraps the application"
    - "Client types and Zod schemas exist for validation"
    - "shadcn/ui Table component is available"
  artifacts:
    - path: "lib/types/client.ts"
      provides: "Client TypeScript types"
      exports: ["Client", "ClientInsert", "ClientUpdate"]
    - path: "lib/validations/client.ts"
      provides: "Zod validation schemas"
      exports: ["clientCreateSchema", "clientUpdateSchema", "ClientCreateInput", "ClientUpdateInput"]
    - path: "components/providers/query-provider.tsx"
      provides: "TanStack Query context provider"
      exports: ["QueryProvider"]
    - path: "components/ui/table.tsx"
      provides: "shadcn/ui Table primitives"
  key_links:
    - from: "app/layout.tsx"
      to: "components/providers/query-provider.tsx"
      via: "QueryProvider wrapper"
      pattern: "QueryProvider"
---

# Foundation - Dependencies, Types, and Query Provider

## Objective
Install required dependencies and set up the foundational infrastructure (types, validation schemas, Query provider, Table component) needed for client CRUD operations.

## Tasks

<task id="1">
<title>Install TanStack Query, TanStack Table, react-hook-form, and Zod</title>
<action>
Run the following command to install all required dependencies:

```bash
npm install @tanstack/react-query @tanstack/react-query-devtools @tanstack/react-table react-hook-form @hookform/resolvers zod
```

Verify installation by checking package.json includes all packages.
</action>
<verify>
Run `npm list @tanstack/react-query @tanstack/react-table react-hook-form zod` - all packages should be listed without errors.
</verify>
</task>

<task id="2" depends_on="1">
<title>Create Client types and Zod validation schemas</title>
<action>
Create `lib/types/client.ts`:

```typescript
// Client type matching Supabase schema
export interface Client {
  id: string;
  user_id: string;
  name: string;
  date_of_birth: string; // ISO date string YYYY-MM-DD
  state: string; // 2-letter state code
  filing_status: "single" | "married_filing_jointly" | "married_filing_separately" | "head_of_household";
  created_at: string;
  updated_at: string;
}

// For creating a new client (no id, timestamps auto-generated)
export type ClientInsert = Omit<Client, "id" | "user_id" | "created_at" | "updated_at">;

// For updating a client (all fields optional except id)
export type ClientUpdate = Partial<ClientInsert>;
```

Create `lib/validations/client.ts`:

```typescript
import { z } from "zod";

export const clientCreateSchema = z.object({
  name: z.string().min(1, "Name is required").max(100, "Name must be 100 characters or less"),
  date_of_birth: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, "Date must be in YYYY-MM-DD format"),
  state: z.string().length(2, "Use 2-letter state code (e.g., CA, NY)"),
  filing_status: z.enum(
    ["single", "married_filing_jointly", "married_filing_separately", "head_of_household"],
    { errorMap: () => ({ message: "Select a valid filing status" }) }
  ),
});

export const clientUpdateSchema = clientCreateSchema.partial();

// Infer types from schemas for form usage
export type ClientCreateInput = z.infer<typeof clientCreateSchema>;
export type ClientUpdateInput = z.infer<typeof clientUpdateSchema>;
```
</action>
<verify>
1. Run `npx tsc --noEmit` - no type errors
2. Verify files exist: `ls lib/types/client.ts lib/validations/client.ts`
</verify>
</task>

<task id="3" depends_on="1">
<title>Set up TanStack Query provider and add shadcn Table</title>
<action>
**Step 1:** Add shadcn/ui Table component:

```bash
npx shadcn@latest add table
```

**Step 2:** Create `components/providers/query-provider.tsx`:

```typescript
"use client";

import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { ReactQueryDevtools } from "@tanstack/react-query-devtools";
import { useState } from "react";

export function QueryProvider({ children }: { children: React.ReactNode }) {
  // Create QueryClient inside useState to prevent sharing between requests in SSR
  const [queryClient] = useState(
    () =>
      new QueryClient({
        defaultOptions: {
          queries: {
            staleTime: 60 * 1000, // Data considered fresh for 1 minute
            refetchOnWindowFocus: false, // Don't refetch when window regains focus
          },
        },
      })
  );

  return (
    <QueryClientProvider client={queryClient}>
      {children}
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
}
```

**Step 3:** Wrap the application with QueryProvider in `app/layout.tsx`:

Add import at top:
```typescript
import { QueryProvider } from "@/components/providers/query-provider";
```

Wrap children in the body:
```typescript
<body className={`${geistSans.variable} ${geistMono.variable} antialiased`}>
  <QueryProvider>
    {children}
  </QueryProvider>
</body>
```

**CRITICAL:** The QueryProvider must be a client component ("use client" directive) because TanStack Query uses React Context.
</action>
<verify>
1. Run `npm run dev` - app starts without errors
2. Open browser DevTools - React Query Devtools icon should appear in bottom-left corner
3. Run `npx tsc --noEmit` - no type errors
4. Verify Table component exists: `ls components/ui/table.tsx`
</verify>
</task>

## Verification

After completing all tasks:

1. **Dependencies installed:**
   ```bash
   npm list @tanstack/react-query @tanstack/react-table react-hook-form zod
   ```
   All packages should be listed.

2. **Type checking passes:**
   ```bash
   npx tsc --noEmit
   ```
   No errors.

3. **Dev server runs:**
   ```bash
   npm run dev
   ```
   App loads at http://localhost:3000 without errors.

4. **React Query Devtools visible:**
   Open browser, look for React Query Devtools icon in corner.

## Rollback

If this plan fails:
1. Run `npm uninstall @tanstack/react-query @tanstack/react-query-devtools @tanstack/react-table react-hook-form @hookform/resolvers zod`
2. Remove created files: `rm -rf lib/types lib/validations components/providers`
3. Revert app/layout.tsx changes
