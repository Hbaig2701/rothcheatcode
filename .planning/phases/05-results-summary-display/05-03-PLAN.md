---
phase: 05-results-summary-display
plan: 03
type: execute
wave: 3
depends_on: [05-01, 05-02]
files_modified:
  - components/results/results-summary.tsx
  - app/(dashboard)/clients/[id]/results/page.tsx
  - app/(dashboard)/clients/[id]/page.tsx
autonomous: false

must_haves:
  truths:
    - "Results page displays summary cards and wealth chart for a client"
    - "Page fetches projection data using useProjection hook"
    - "Client detail page has navigation link to results"
    - "Results page handles loading and error states"
  artifacts:
    - path: "components/results/results-summary.tsx"
      provides: "Main container component for results display"
      min_lines: 50
    - path: "app/(dashboard)/clients/[id]/results/page.tsx"
      provides: "Results page route"
      min_lines: 30
  key_links:
    - from: "components/results/results-summary.tsx"
      to: "components/results/index.ts"
      via: "import SummarySection, WealthChart"
      pattern: "import.*from.*@/components/results"
    - from: "components/results/results-summary.tsx"
      to: "lib/hooks/use-projection.ts"
      via: "import useProjection"
      pattern: "import.*useProjection"
    - from: "app/(dashboard)/clients/[id]/page.tsx"
      to: "app/(dashboard)/clients/[id]/results/page.tsx"
      via: "Link to results"
      pattern: "href.*results"
---

<objective>
Wire the results page with all components and add navigation from client detail.

Purpose: Complete the results display feature by creating the container component, results page route, and navigation from the client detail page.
Output: Working results page at /clients/[id]/results showing projection summary and wealth chart.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-results-summary-display/05-RESEARCH.md
@.planning/phases/05-results-summary-display/05-01-SUMMARY.md
@.planning/phases/05-results-summary-display/05-02-SUMMARY.md

@lib/hooks/use-projection.ts
@lib/calculations/transforms.ts
@components/results/index.ts
@app/(dashboard)/clients/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ResultsSummary container component</name>
  <files>components/results/results-summary.tsx</files>
  <action>
Create `components/results/results-summary.tsx` - the main container that orchestrates the results display.

```typescript
'use client';

import { useProjection } from '@/lib/hooks/use-projection';
import { transformToChartData, extractSummaryMetrics } from '@/lib/calculations/transforms';
import { SummarySection } from './summary-section';
import { WealthChart } from './wealth-chart';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Skeleton } from '@/components/ui/skeleton';
import { AlertCircle, RefreshCw } from 'lucide-react';
import { Button } from '@/components/ui/button';

interface ResultsSummaryProps {
  clientId: string;
  clientName: string;
}

export function ResultsSummary({ clientId, clientName }: ResultsSummaryProps) {
  const { data, isLoading, isError, error, refetch } = useProjection(clientId);

  // Loading state
  if (isLoading) {
    return (
      <div className="space-y-6">
        <div>
          <h1 className="text-2xl font-bold">Results for {clientName}</h1>
          <p className="text-muted-foreground">Calculating projections...</p>
        </div>
        <div className="grid gap-4 md:grid-cols-3">
          <Skeleton className="h-[120px]" />
          <Skeleton className="h-[120px]" />
          <Skeleton className="h-[120px]" />
        </div>
        <Skeleton className="h-[400px]" />
      </div>
    );
  }

  // Error state
  if (isError) {
    return (
      <div className="space-y-6">
        <div>
          <h1 className="text-2xl font-bold">Results for {clientName}</h1>
        </div>
        <Card className="border-destructive">
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-destructive">
              <AlertCircle className="h-5 w-5" />
              Error Loading Results
            </CardTitle>
            <CardDescription>
              {error instanceof Error ? error.message : 'Failed to load projection data'}
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button onClick={() => refetch()} variant="outline">
              <RefreshCw className="mr-2 h-4 w-4" />
              Try Again
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // No data state (shouldn't happen but defensive)
  if (!data?.projection) {
    return (
      <div className="space-y-6">
        <div>
          <h1 className="text-2xl font-bold">Results for {clientName}</h1>
        </div>
        <Card>
          <CardHeader>
            <CardTitle>No Projection Data</CardTitle>
            <CardDescription>
              No projection has been calculated for this client yet.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button onClick={() => refetch()}>
              <RefreshCw className="mr-2 h-4 w-4" />
              Calculate Projection
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Transform data for display
  const { projection, cached } = data;
  const chartData = transformToChartData(projection);
  const metrics = extractSummaryMetrics(projection);

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Results for {clientName}</h1>
          <p className="text-muted-foreground">
            {projection.projection_years}-year projection using {projection.strategy} strategy
            {cached && <span className="ml-2 text-xs">(cached)</span>}
          </p>
        </div>
        <Button
          variant="outline"
          size="sm"
          onClick={() => refetch()}
          title="Recalculate with current client data"
        >
          <RefreshCw className="mr-2 h-4 w-4" />
          Recalculate
        </Button>
      </div>

      {/* Summary Cards */}
      <SummarySection metrics={metrics} />

      {/* Wealth Chart */}
      <Card>
        <CardHeader>
          <CardTitle>Wealth Projection</CardTitle>
          <CardDescription>
            Comparing net worth over time: Baseline (no conversion) vs Blueprint (Roth conversion)
          </CardDescription>
        </CardHeader>
        <CardContent>
          <WealthChart data={chartData} breakEvenAge={metrics.breakEvenAge} />
        </CardContent>
      </Card>

      {/* Additional metrics footer */}
      {metrics.heirBenefit > 0 && (
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-muted-foreground">Benefit to Heirs</p>
                <p className="text-xl font-semibold text-green-600">
                  +${(metrics.heirBenefit / 100).toLocaleString()}
                </p>
              </div>
              <p className="text-sm text-muted-foreground max-w-md">
                Based on current heir tax bracket, heirs would receive more from the Blueprint scenario
                due to tax-free Roth distributions.
              </p>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
```

Also update the barrel export `components/results/index.ts` to include ResultsSummary:

```typescript
export { StatCard } from './stat-card';
export { ChartTooltip } from './chart-tooltip';
export { WealthChart } from './wealth-chart';
export { SummarySection } from './summary-section';
export { ResultsSummary } from './results-summary';
```

Key implementation notes:
- Uses `useProjection` hook to fetch data with loading/error states
- Skeleton loading shows 3 cards + chart placeholder
- Error state has retry button
- Shows "cached" indicator if using cached projection
- Recalculate button for manual refresh
- Heir benefit card shown conditionally if positive
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile without errors.
Check file exists: `ls components/results/results-summary.tsx`
Check barrel export updated: `grep "ResultsSummary" components/results/index.ts`
  </verify>
  <done>
ResultsSummary container handles loading, error, and data states with proper UX.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create results page and add navigation</name>
  <files>
    app/(dashboard)/clients/[id]/results/page.tsx
    app/(dashboard)/clients/[id]/page.tsx
  </files>
  <action>
Create `app/(dashboard)/clients/[id]/results/page.tsx`:

```typescript
import { createClient } from '@/lib/supabase/server';
import { notFound } from 'next/navigation';
import { ResultsSummary } from '@/components/results';

interface ResultsPageProps {
  params: Promise<{ id: string }>;
}

export default async function ResultsPage({ params }: ResultsPageProps) {
  const { id } = await params;
  const supabase = await createClient();

  // Fetch client name for display (minimal data, projection fetched client-side)
  const { data: client, error } = await supabase
    .from('clients')
    .select('id, name')
    .eq('id', id)
    .single();

  if (error || !client) {
    notFound();
  }

  return (
    <div className="container py-6">
      <ResultsSummary clientId={client.id} clientName={client.name} />
    </div>
  );
}

export async function generateMetadata({ params }: ResultsPageProps) {
  const { id } = await params;
  const supabase = await createClient();

  const { data: client } = await supabase
    .from('clients')
    .select('name')
    .eq('id', id)
    .single();

  return {
    title: client ? `Results - ${client.name}` : 'Results',
    description: 'Roth conversion projection results',
  };
}
```

Update `app/(dashboard)/clients/[id]/page.tsx` to add navigation link to results:

Find the existing client detail page and add a "View Results" button/link. The exact implementation depends on the current page structure, but add somewhere prominent:

```typescript
// Add import at top
import { Button, buttonVariants } from '@/components/ui/button';
import { BarChart3 } from 'lucide-react';
import Link from 'next/link';

// Add in the actions area (near Edit button or header)
<Link
  href={`/clients/${client.id}/results`}
  className={buttonVariants({ variant: 'default' })}
>
  <BarChart3 className="mr-2 h-4 w-4" />
  View Results
</Link>
```

Key implementation notes:
- Results page is server component for initial load (fetches client name)
- ResultsSummary is client component (uses hooks for projection data)
- Next.js 15 async params pattern: `await params`
- generateMetadata for SEO
- Button uses BarChart3 icon for visual consistency
- Link navigates to /clients/[id]/results
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile without errors.
Check page file exists: `ls app/\(dashboard\)/clients/\[id\]/results/page.tsx`
Check client page has link: `grep -l "results" app/\(dashboard\)/clients/\[id\]/page.tsx`
  </verify>
  <done>
Results page route created at /clients/[id]/results with navigation from client detail page.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete results summary display with:
- Summary cards showing Baseline, Blueprint, and Tax Savings
- Wealth divergence chart with breakeven marker
- Count-up animations on stat cards
- Navigation from client detail page
  </what-built>
  <how-to-verify>
1. Go to https://rothc-lime.vercel.app
2. Log in and navigate to an existing client
3. Click "View Results" button
4. Verify on /clients/[id]/results page:
   - Three stat cards animate from 0 to final values
   - Blueprint card has blue border highlight
   - Chart shows two lines (gray baseline, blue blueprint)
   - Hover over chart shows tooltip with values
   - If breakeven exists, green dashed vertical line appears
5. Check loading state by refreshing page (skeleton should show briefly)
6. Click "Recalculate" button - should refresh data
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the results display</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes with no errors
2. Results page loads at /clients/[id]/results
3. Summary cards display with count-up animation
4. Wealth chart renders with both lines visible
5. Breakeven marker appears when applicable
6. Navigation works from client detail page
7. Loading and error states display correctly
</verification>

<success_criteria>
- ResultsSummary handles loading, error, and success states
- Results page fetches client name server-side, projection client-side
- Client detail page has prominent "View Results" button
- Count-up animation triggers on page load
- Chart displays gray baseline and blue blueprint lines
- Tooltip shows formatted currency values on hover
- Breakeven ReferenceLine shows at correct age
</success_criteria>

<output>
After completion, create `.planning/phases/05-results-summary-display/05-03-SUMMARY.md`
</output>
