---
phase: 07-deep-dive-views
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - components/results/deep-dive/irmaa-chart.tsx
  - components/results/deep-dive/niit-display.tsx
  - components/results/deep-dive/index.ts
autonomous: true

must_haves:
  truths:
    - "IRMAA chart shows MAGI over time with threshold reference lines"
    - "User can see which years exceed IRMAA thresholds visually"
    - "NIIT display shows threshold and years where 3.8% tax applies"
  artifacts:
    - path: "components/results/deep-dive/irmaa-chart.tsx"
      provides: "IRMAA bar chart with threshold lines"
      exports: ["IRMAAChart"]
    - path: "components/results/deep-dive/niit-display.tsx"
      provides: "NIIT calculation display card"
      exports: ["NIITDisplay"]
  key_links:
    - from: "components/results/deep-dive/irmaa-chart.tsx"
      to: "lib/data/irmaa-brackets.ts"
      via: "IRMAA threshold data import"
      pattern: "import.*IRMAA_TIERS_2026"
    - from: "components/results/deep-dive/irmaa-chart.tsx"
      to: "recharts"
      via: "BarChart and ReferenceLine components"
      pattern: "import.*BarChart.*ReferenceLine.*from.*recharts"
---

<objective>
Create IRMAA visualization chart and NIIT calculation display components.

Purpose: Help advisors visualize income relative to Medicare premium thresholds and understand Net Investment Income Tax impact. IRMAA cliff visualization is a key competitive differentiator.

Output: IRMAAChart component with bar chart and threshold lines, NIITDisplay card showing tax calculation breakdown.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@rothc/.planning/PROJECT.md
@rothc/.planning/ROADMAP.md
@rothc/.planning/STATE.md
@rothc/.planning/phases/07-deep-dive-views/07-RESEARCH.md

# Key existing files
@rothc/lib/calculations/types.ts
@rothc/lib/calculations/transforms.ts
@rothc/lib/data/irmaa-brackets.ts
@rothc/components/ui/card.tsx
@rothc/components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IRMAAChart component with threshold lines</name>
  <files>components/results/deep-dive/irmaa-chart.tsx</files>
  <action>
Create `components/results/deep-dive/irmaa-chart.tsx`:

1. Import dependencies:
   - Recharts: BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine, Legend
   - `YearlyResult` from `@/lib/calculations/types`
   - `IRMAA_TIERS_2026` from `@/lib/data/irmaa-brackets`
   - `formatCurrency, formatAxisValue` from `@/lib/calculations/transforms`
   - Card components from `@/components/ui/card`

2. Create helper function to get IRMAA thresholds with colors:
```typescript
function getIRMAAThresholds(isJoint: boolean) {
  // Return thresholds for tiers 1-5 (skip tier 0 standard)
  // Use appropriate upper threshold based on filing status
  // Colors: green, yellow, orange, red, dark red for increasing severity
  const colors = ['#22c55e', '#eab308', '#f97316', '#ef4444', '#991b1b'];
  return IRMAA_TIERS_2026.slice(1).map((tier, index) => ({
    value: isJoint ? tier.jointLower : tier.singleLower,
    label: `Tier ${index + 1}`,
    color: colors[index],
  }));
}
```

3. Create IRMAAChart component:
   - Props: `years: YearlyResult[]`, `filingStatus: string`
   - Transform data: extract age, year, and totalIncome (as MAGI proxy) from each year
   - Render in Card with CardHeader and CardContent
   - Title: "IRMAA Income Thresholds"
   - Use ResponsiveContainer with 100% width and 400px height
   - BarChart with CartesianGrid (strokeDasharray="3 3")
   - XAxis showing age, YAxis formatted with formatAxisValue
   - Bar for MAGI with fill="#3b82f6" (blue)
   - Add ReferenceLine for each IRMAA threshold:
     - Horizontal line at threshold value
     - strokeDasharray="5 5" for dashed line
     - Label positioned to right showing tier name
   - Add Tooltip with formatCurrency for values
   - Add Legend below chart explaining threshold colors

4. Add threshold legend section below chart:
   - Flex wrap container showing each tier with color dot and dollar threshold
   - Text: "Tier 1: $XXX,XXX" etc.

5. Export component.

Key implementation details:
- Use `isJoint = filingStatus === 'married_filing_jointly'` for threshold selection
- ReferenceLine y prop takes the threshold value in cents
- Label position 'right' keeps labels from overlapping chart area
  </action>
  <verify>
- File exists at `components/results/deep-dive/irmaa-chart.tsx`
- TypeScript compiles: `npm run build`
- Component exports IRMAAChart
  </verify>
  <done>IRMAAChart displays MAGI as bars with 5 horizontal dashed reference lines at IRMAA tier thresholds, color-coded legend showing threshold amounts</done>
</task>

<task type="auto">
  <name>Task 2: Create NIITDisplay component</name>
  <files>components/results/deep-dive/niit-display.tsx</files>
  <action>
Create `components/results/deep-dive/niit-display.tsx`:

1. Import dependencies:
   - Card, CardContent, CardHeader, CardTitle from `@/components/ui/card`
   - Badge from `@/components/ui/badge`
   - `YearlyResult` from `@/lib/calculations/types`
   - `formatCurrency` from `@/lib/calculations/transforms`

2. Define NIIT thresholds constant (in cents):
```typescript
const NIIT_THRESHOLDS: Record<string, number> = {
  single: 20000000,                    // $200,000
  married_filing_jointly: 25000000,    // $250,000
  married_filing_separately: 12500000, // $125,000
  head_of_household: 20000000,         // $200,000
};
```

3. Create NIITDisplay component:
   - Props: `years: YearlyResult[]`, `filingStatus: string`
   - Calculate:
     - `threshold` from NIIT_THRESHOLDS based on filingStatus
     - `niitYears` = years where niitTax > 0
     - `totalNIIT` = sum of niitTax across all years

4. Render Card with:
   - CardTitle: "Net Investment Income Tax (3.8%)"
   - Badge showing "Applies" (destructive variant) or "Below Threshold" (green outline)
   - Row showing "MAGI Threshold" with formatted threshold amount

5. Conditional content based on totalNIIT > 0:
   - If applies: Show total NIIT in red, list of years with NIIT in scrollable container
   - If not: Explanatory text that MAGI stays below threshold

6. Footer text explaining NIIT: "NIIT is 3.8% on the lesser of net investment income or excess MAGI above the threshold. Roth conversions can increase MAGI and trigger NIIT."

7. Export component.

Key implementation details:
- Use max-h-32 overflow-y-auto for years list to keep card compact
- Red background for "applies" state, muted background for threshold row
- Show year and age for each NIIT year for easy reference
  </action>
  <verify>
- File exists at `components/results/deep-dive/niit-display.tsx`
- TypeScript compiles: `npm run build`
- Component exports NIITDisplay
  </verify>
  <done>NIITDisplay shows MAGI threshold for filing status, total NIIT paid across projection, and list of years where NIIT applies</done>
</task>

<task type="auto">
  <name>Task 3: Update barrel exports</name>
  <files>components/results/deep-dive/index.ts</files>
  <action>
Update `components/results/deep-dive/index.ts` to add new exports:

```typescript
// Deep Dive Views (Phase 07)
export { YearByYearTable } from './year-by-year-table';
export { IRMAAChart } from './irmaa-chart';
export { NIITDisplay } from './niit-display';
```

Note: If 07-01 hasn't run yet, create the file with all exports. The YearByYearTable export will resolve when 07-01 completes.
  </action>
  <verify>
- `npm run build` passes
- All three components exported from barrel
  </verify>
  <done>Barrel export updated with IRMAAChart and NIITDisplay</done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no TypeScript errors
2. IRMAAChart renders bar chart with threshold reference lines
3. NIITDisplay shows threshold and NIIT years appropriately
4. Both components properly typed with YearlyResult and filingStatus props
</verification>

<success_criteria>
- IRMAAChart displays MAGI over time as bars
- 5 IRMAA tier thresholds shown as dashed horizontal reference lines
- Threshold legend shows tier amounts with color coding
- NIITDisplay shows MAGI threshold based on filing status
- NIIT summary shows total tax and affected years
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-deep-dive-views/07-02-SUMMARY.md`
</output>
