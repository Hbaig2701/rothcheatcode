---
phase: 09-pdf-export
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - app/api/pdf/[clientId]/route.ts
  - hooks/use-pdf-export.ts
  - components/results/pdf-export-button.tsx
  - app/(dashboard)/clients/[id]/results/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can click Download PDF button on results page"
    - "PDF downloads with correct filename containing client name"
    - "PDF contains summary metrics, charts, and tables"
    - "PDF has disclaimer footer on every page"
    - "PDF generation completes in under 5 seconds"
  artifacts:
    - path: "app/api/pdf/[clientId]/route.ts"
      provides: "Server-side PDF generation endpoint"
      exports: ["POST"]
      min_lines: 60
    - path: "hooks/use-pdf-export.ts"
      provides: "Client-side hook for chart capture and PDF download"
      exports: ["usePDFExport"]
      min_lines: 70
    - path: "components/results/pdf-export-button.tsx"
      provides: "Download PDF button with loading state"
      min_lines: 40
  key_links:
    - from: "hooks/use-pdf-export.ts"
      to: "/api/pdf/[clientId]"
      via: "fetch POST request"
      pattern: "fetch.*api/pdf"
    - from: "app/api/pdf/[clientId]/route.ts"
      to: "lib/pdf"
      via: "PDFDocument import"
      pattern: "import.*PDFDocument.*from.*lib/pdf"
    - from: "app/(dashboard)/clients/[id]/results/page.tsx"
      to: "components/results/pdf-export-button.tsx"
      via: "PDFExportButton import"
      pattern: "PDFExportButton"
---

<objective>
Create the API endpoint, client hook, and UI button to enable PDF download from results page.

Purpose: Wire up end-to-end PDF export flow - capture charts on client, generate PDF on server, download to user.
Output: Working "Download PDF" button on results page that produces a professional report.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-pdf-export/09-RESEARCH.md
@.planning/phases/09-pdf-export/09-01-SUMMARY.md
@.planning/phases/09-pdf-export/09-02-SUMMARY.md

# PDF components from previous plan
@lib/pdf/index.ts

# Existing results page structure
@app/(dashboard)/clients/[id]/results/page.tsx
@components/results/multi-strategy-results.tsx
@components/results/wealth-chart.tsx
@components/results/breakeven-chart.tsx

# Queries and types
@lib/queries/projections.ts
@lib/queries/clients.ts
@lib/calculations/multi-strategy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PDF generation API route</name>
  <files>app/api/pdf/[clientId]/route.ts</files>
  <action>
    Create app/api/pdf/[clientId]/route.ts:

    1. Import dependencies:
       - pdf from '@react-pdf/renderer'
       - PDFDocument from '@/lib/pdf'
       - createClient from '@/lib/supabase/server'
       - runMultiStrategySimulation from '@/lib/calculations/multi-strategy'
       - Client type from '@/lib/types/client'

    2. Add route segment config:
       ```typescript
       export const dynamic = 'force-dynamic';
       export const maxDuration = 10; // 10 second timeout for Vercel
       ```

    3. POST handler:
       - Parse params: `const { clientId } = await params;`
       - Parse body: `const { chartImages } = await request.json();`
       - Get authenticated user via Supabase
       - Return 401 if not authenticated
       - Fetch client data from database
       - Return 404 if client not found or not owned by user
       - Run multi-strategy simulation to get metrics
       - Extract summary metrics from simulation result
       - Call `pdf(<PDFDocument ... />).toBuffer()`
       - Return Response with:
         * Content-Type: application/pdf
         * Content-Disposition: attachment; filename="roth-analysis-{clientName}.pdf"

    4. Helper function to transform simulation result to PDF data format

    5. Error handling: try/catch returning 500 on failure
  </action>
  <verify>
    - TypeScript compiles without errors
    - Route file exists at app/api/pdf/[clientId]/route.ts
    - Exports POST function
  </verify>
  <done>PDF API endpoint ready to generate PDFs from client data</done>
</task>

<task type="auto">
  <name>Task 2: Create client-side PDF export hook and button</name>
  <files>
    hooks/use-pdf-export.ts
    components/results/pdf-export-button.tsx
  </files>
  <action>
    1. Create hooks/use-pdf-export.ts:
       - 'use client' directive
       - Import useState, RefObject from 'react'
       - Import toPng from 'html-to-image'

       Interface ChartRefs:
       - wealth: RefObject<HTMLDivElement | null>
       - breakeven?: RefObject<HTMLDivElement | null>
       - sensitivity?: RefObject<HTMLDivElement | null>

       Function usePDFExport(clientId: string, clientName: string):
       - State: isGenerating (boolean), error (string | null)

       Helper captureChart(ref: RefObject<HTMLDivElement | null>):
       - Return null if ref.current is null
       - await small delay (100ms) for animations
       - Call toPng with options: quality 0.85, pixelRatio 2, backgroundColor '#ffffff'
       - Return base64 data URL or null on error

       Function generatePDF(chartRefs: ChartRefs):
       - Set isGenerating true, clear error
       - Capture charts SEQUENTIALLY (not parallel - memory issues)
       - Call fetch POST to /api/pdf/{clientId} with chartImages body
       - Check response.ok, throw if not
       - Get blob from response
       - Create object URL, create <a> element, trigger download
       - Cleanup: revoke URL, remove element
       - Set isGenerating false
       - On error: set error message, set isGenerating false

       Return { generatePDF, isGenerating, error }

    2. Create components/results/pdf-export-button.tsx:
       - 'use client' directive
       - Import Button from '@/components/ui/button'
       - Import Download, Loader2 icons from 'lucide-react'
       - Import usePDFExport from '@/hooks/use-pdf-export'

       Props: clientId, clientName, chartRefs (passed from parent)

       - Get { generatePDF, isGenerating, error } from hook
       - Render Button with:
         * onClick={() => generatePDF(chartRefs)}
         * disabled={isGenerating}
         * Loading state: Loader2 spinning + "Generating..."
         * Normal state: Download icon + "Download PDF"
       - Show error toast or inline error if error state exists
  </action>
  <verify>
    - TypeScript compiles without errors
    - usePDFExport hook exports correctly
    - PDFExportButton renders with loading states
  </verify>
  <done>Client-side export hook and button component created</done>
</task>

<task type="auto">
  <name>Task 3: Integrate PDF button into results page with chart refs</name>
  <files>app/(dashboard)/clients/[id]/results/page.tsx</files>
  <action>
    Update app/(dashboard)/clients/[id]/results/page.tsx:

    1. Add imports:
       - useRef from 'react'
       - PDFExportButton from '@/components/results/pdf-export-button'

    2. Create refs for charts:
       ```typescript
       const wealthChartRef = useRef<HTMLDivElement>(null);
       const breakevenChartRef = useRef<HTMLDivElement>(null);
       ```

    3. In the header section (after the back button and title), add:
       ```tsx
       <PDFExportButton
         clientId={clientId}
         clientName={client.name}
         chartRefs={{
           wealth: wealthChartRef,
           breakeven: breakevenChartRef,
         }}
       />
       ```

    4. Wrap the chart components with div refs:
       - The MultiStrategyResults component contains WealthChart internally
       - Need to update MultiStrategyResults to accept a wealthChartRef prop
       - Or wrap the chart section in a div with ref

       Simpler approach: Add ref div wrapper around the sections containing charts.
       The WealthChart is inside MultiStrategyResults, so either:
       a) Pass ref to MultiStrategyResults and have it forward to WealthChart's container
       b) Wrap the entire MultiStrategyResults in a div with ref (captures more than needed but simpler)

       Recommended: Option (a) - modify MultiStrategyResults to accept wealthChartRef prop

    5. For breakeven chart in AdvancedFeaturesSection:
       - Similar approach: pass breakevenChartRef as prop

    NOTE: The html-to-image library captures whatever DOM element the ref points to.
    The ref should wrap ONLY the chart SVG container, not the entire card with headers.
  </action>
  <verify>
    - TypeScript compiles without errors
    - PDFExportButton appears in results page header
    - Chart refs are properly connected
  </verify>
  <done>PDF export button integrated into results page</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete PDF export functionality:
    - Download PDF button on results page
    - Server-side PDF generation with summary, charts, and tables
    - Client-side chart capture using html-to-image
    - Professional report with header, footer, and disclaimer
  </what-built>
  <how-to-verify>
    1. Navigate to a client with calculation results at https://rothc-lime.vercel.app
    2. Go to the Results page for that client
    3. Click the "Download PDF" button in the header
    4. Wait for generation (should be < 5 seconds)
    5. Verify downloaded PDF contains:
       - Header with client name and generation date
       - Executive summary with key metrics
       - Wealth projection chart
       - Strategy comparison table (4 strategies)
       - Year-by-year projection table
       - Disclaimer footer on every page
       - Page numbers ("Page 1 of 3")
    6. Verify PDF opens correctly in standard PDF viewer
  </how-to-verify>
  <resume-signal>Type "approved" if PDF downloads correctly with all sections, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- PDF API route responds to POST requests
- usePDFExport hook captures charts and triggers download
- Download PDF button visible on results page
- Generated PDF contains all required sections
- Generation time < 5 seconds
</verification>

<success_criteria>
- User can click "Download PDF" on any client's results page
- PDF downloads with filename containing client name
- PDF has 3 pages: Summary, Strategy Comparison, Year-by-Year
- Charts render as images in the PDF
- Disclaimer footer appears on every page
- No JavaScript errors during export process
- Performance requirement met (< 5 seconds)
</success_criteria>

<output>
After completion, create `.planning/phases/09-pdf-export/09-03-SUMMARY.md`
</output>
