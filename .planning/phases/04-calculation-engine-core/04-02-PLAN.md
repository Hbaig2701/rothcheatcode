---
phase: 04-calculation-engine-core
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - lib/calculations/modules/rmd.ts
  - lib/calculations/modules/federal-tax.ts
  - lib/calculations/modules/state-tax.ts
  - lib/calculations/modules/niit.ts
  - lib/data/state-brackets.ts
autonomous: true

must_haves:
  truths:
    - "RMD calculation returns correct amounts based on age and prior year balance"
    - "Federal tax calculation returns progressive tax across all brackets"
    - "State tax handles flat, progressive, and no-tax states correctly"
    - "NIIT calculation applies 3.8% above MAGI thresholds"
  artifacts:
    - path: "lib/calculations/modules/rmd.ts"
      provides: "RMD calculation logic"
      exports: ["calculateRMD"]
    - path: "lib/calculations/modules/federal-tax.ts"
      provides: "Progressive federal tax calculation"
      exports: ["calculateFederalTax"]
    - path: "lib/calculations/modules/state-tax.ts"
      provides: "State income tax calculation"
      exports: ["calculateStateTax"]
    - path: "lib/calculations/modules/niit.ts"
      provides: "Net Investment Income Tax calculation"
      exports: ["calculateNIIT"]
    - path: "lib/data/state-brackets.ts"
      provides: "Progressive state tax bracket data"
      contains: "STATE_TAX_BRACKETS"
  key_links:
    - from: "lib/calculations/modules/rmd.ts"
      to: "lib/data/rmd-factors.ts"
      via: "import UNIFORM_LIFETIME_TABLE"
      pattern: "import.*UNIFORM_LIFETIME_TABLE"
    - from: "lib/calculations/modules/federal-tax.ts"
      to: "lib/data/federal-brackets-2026.ts"
      via: "import getFederalBrackets"
      pattern: "import.*getFederalBrackets"
    - from: "lib/calculations/modules/state-tax.ts"
      to: "lib/data/state-brackets.ts"
      via: "import STATE_TAX_BRACKETS"
      pattern: "import.*STATE_TAX_BRACKETS"
---

<objective>
Build core tax calculation modules: RMD, federal tax, state tax, and NIIT.

Purpose: These are the foundational calculations that the simulation engine will use for each projection year.
Output: Four pure function modules that take typed inputs and return typed results, all in cents.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-calculation-engine-core/04-RESEARCH.md
@.planning/phases/04-calculation-engine-core/04-01-SUMMARY.md

@lib/calculations/types.ts
@lib/data/rmd-factors.ts
@lib/data/federal-brackets-2026.ts
@lib/data/states.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RMD and NIIT calculation modules</name>
  <files>
    lib/calculations/modules/rmd.ts
    lib/calculations/modules/niit.ts
  </files>
  <action>
Create `lib/calculations/modules/rmd.ts`:
- Import `RMDInput`, `RMDResult` from `../types`
- Import `UNIFORM_LIFETIME_TABLE`, `getDistributionPeriod` from `@/lib/data/rmd-factors`
- Import `getRMDStartAge` from `../utils/age`
- Implement `calculateRMD(input: RMDInput): RMDResult`:
  1. Determine RMD start age using `getRMDStartAge(input.birthYear)` (73 for 1951-1959, 75 for 1960+)
  2. If `input.age < rmdStartAge`, return `{ rmdRequired: false, rmdAmount: 0, distributionPeriod: 0 }`
  3. Get distribution period using `getDistributionPeriod(Math.min(input.age, 120))`
  4. Calculate RMD: `Math.round(input.traditionalBalance / distributionPeriod)`
  5. Return `{ rmdRequired: true, rmdAmount, distributionPeriod }`
- All amounts in cents (input balance, output RMD)

Create `lib/calculations/modules/niit.ts`:
- Import `NIITInput`, `NIITResult` from `../types`
- Define NIIT_THRESHOLDS in cents:
  ```typescript
  const NIIT_THRESHOLDS = {
    single: 20000000,                    // $200,000
    married_filing_jointly: 25000000,    // $250,000
    married_filing_separately: 12500000, // $125,000
    head_of_household: 20000000          // $200,000
  };
  const NIIT_RATE = 0.038; // 3.8%
  ```
- Implement `calculateNIIT(input: NIITInput): NIITResult`:
  1. Get threshold for filing status
  2. If `input.magi <= threshold`, return `{ applies: false, taxAmount: 0, thresholdExcess: 0 }`
  3. Calculate threshold excess: `input.magi - threshold`
  4. Tax on lesser of NII or excess: `Math.min(input.netInvestmentIncome, thresholdExcess)`
  5. Tax amount: `Math.round(taxableAmount * NIIT_RATE)`
  6. Return result object
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile.
Verify RMD logic: For age 75, birthYear 1955, balance $500,000 (50000000 cents), RMD = 50000000 / 24.6 = ~2032520 cents ($20,325.20)
Verify NIIT logic: For MAGI $300,000 (30000000 cents), NII $50,000, married filing jointly:
  - Threshold: $250,000, excess: $50,000
  - Tax: min(5000000, 5000000) * 0.038 = 190000 cents ($1,900)
  </verify>
  <done>
RMD module correctly implements SECURE 2.0 age rules. NIIT module applies 3.8% tax on lesser of NII or MAGI excess.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create progressive state tax brackets and state tax module</name>
  <files>
    lib/data/state-brackets.ts
    lib/calculations/modules/state-tax.ts
  </files>
  <action>
Create `lib/data/state-brackets.ts`:
- Import `TaxBracket` from `@/lib/calculations/types`
- Define state bracket data for top 10 progressive states (CA, NY, NJ, HI, MN, OR, DC, VT, MA, WI)
- Structure: `STATE_TAX_BRACKETS: Record<string, { single: TaxBracket[], married_jointly: TaxBracket[] }>`
- For remaining progressive states, use top rate as single bracket (fallback)
- Include comment noting that full bracket data can be added incrementally

Example California brackets (in cents):
```typescript
CA: {
  single: [
    { lower: 0, upper: 1096900, rate: 1.0 },
    { lower: 1096900, upper: 2601600, rate: 2.0 },
    { lower: 2601600, upper: 4103700, rate: 4.0 },
    { lower: 4103700, upper: 5694400, rate: 6.0 },
    { lower: 5694400, upper: 7187600, rate: 8.0 },
    { lower: 7187600, upper: 36663800, rate: 9.3 },
    { lower: 36663800, upper: 43996500, rate: 10.3 },
    { lower: 43996500, upper: 73327500, rate: 11.3 },
    { lower: 73327500, upper: 146655100, rate: 12.3 },
    { lower: 146655100, upper: Infinity, rate: 13.3 }
  ],
  married_jointly: [ /* similar structure with doubled thresholds */ ]
}
```

Export `getStateBrackets(state: string, filingStatus: string): TaxBracket[] | null`
- Returns null if state has no income tax or is flat rate

Create `lib/calculations/modules/state-tax.ts`:
- Import `StateTaxInput`, `StateTaxResult`, `TaxBracket` from `../types`
- Import `getStateByCode` from `@/lib/data/states`
- Import `getStateBrackets` from `@/lib/data/state-brackets`
- Implement `calculateStateTax(input: StateTaxInput): StateTaxResult`:
  1. Get state info using `getStateByCode(input.state)`
  2. If `taxType === 'none'`, return `{ totalTax: 0, effectiveRate: 0 }`
  3. If `taxType === 'flat'`, return flat rate calculation: `Math.round(input.taxableIncome * state.topRate / 100)`
  4. If `taxType === 'progressive'`:
     - Try `getStateBrackets(input.state, input.filingStatus)`
     - If brackets exist, calculate progressively (same algorithm as federal)
     - If no detailed brackets, use top rate as flat (with comment noting approximation)
  5. Calculate effective rate: `totalTax / taxableIncome * 100`
  6. Return result object
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile.
Verify state tax logic:
- Texas (no tax): Should return 0
- Utah (flat 4.55%): For $100,000 income, tax = 4.55% = $4,550 (455000 cents)
- California (progressive): $100,000 should NOT equal top rate * income
  </verify>
  <done>
State tax module handles all three state types. Top 10 progressive states have full bracket data. Others use top-rate fallback.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create federal tax calculation module</name>
  <files>
    lib/calculations/modules/federal-tax.ts
  </files>
  <action>
Create `lib/calculations/modules/federal-tax.ts`:
- Import `FederalTaxInput`, `FederalTaxResult`, `BracketAmount` from `../types`
- Import `getFederalBrackets` from `@/lib/data/federal-brackets-2026`
- Implement `calculateFederalTax(input: FederalTaxInput): FederalTaxResult`:

Algorithm:
```typescript
export function calculateFederalTax(input: FederalTaxInput): FederalTaxResult {
  const brackets = getFederalBrackets(input.taxYear, input.filingStatus);
  let remainingIncome = input.taxableIncome;
  let totalTax = 0;
  const breakdown: BracketAmount[] = [];

  for (const bracket of brackets) {
    if (remainingIncome <= 0) break;

    // Calculate the width of this bracket
    const bracketWidth = bracket.upper === Infinity
      ? remainingIncome  // Top bracket: all remaining income
      : bracket.upper - bracket.lower;

    // How much of this bracket is taxable
    const taxableInBracket = Math.min(remainingIncome, bracketWidth);

    // Calculate tax for this bracket (rate is percentage, e.g., 22)
    const taxInBracket = Math.round(taxableInBracket * bracket.rate / 100);

    if (taxInBracket > 0) {
      totalTax += taxInBracket;
      breakdown.push({ rate: bracket.rate, amount: taxInBracket });
    }

    remainingIncome -= taxableInBracket;
  }

  const effectiveRate = input.taxableIncome > 0
    ? (totalTax / input.taxableIncome) * 100
    : 0;

  const marginalBracket = breakdown.length > 0
    ? breakdown[breakdown.length - 1].rate
    : 0;

  return {
    totalTax,
    effectiveRate,
    marginalBracket,
    bracketBreakdown: breakdown
  };
}
```

Add helper function `calculateTaxableIncome(grossIncome: number, deductions: number): number`:
- Simply returns `Math.max(0, grossIncome - deductions)`
- Used by simulation engine to compute taxable income from gross
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile.

Manual verification for married filing jointly, $200,000 taxable income (20000000 cents), 2026:
- 10% on first $24,800 = $2,480
- 12% on $24,800 to $100,800 = $9,120
- 22% on $100,800 to $200,000 = $21,824
- Total: $33,424 (3342400 cents)
- Effective rate: 16.71%
- Marginal bracket: 22%
  </verify>
  <done>
Federal tax module calculates progressive tax across all 7 brackets. Returns breakdown showing tax in each bracket hit.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes
2. All 5 module files exist in lib/calculations/modules/ and lib/data/
3. Each module is a pure function with typed input/output
4. No side effects or mutations in any calculation
5. All monetary values handled in cents
</verification>

<success_criteria>
- RMD calculation uses correct SECURE 2.0 age rules (73 vs 75)
- Federal tax returns correct progressive calculation with bracket breakdown
- State tax handles none/flat/progressive states appropriately
- NIIT applies 3.8% on correct income portion
- All calculations are deterministic pure functions
- Types match input/output contracts defined in types.ts
</success_criteria>

<output>
After completion, create `.planning/phases/04-calculation-engine-core/04-02-SUMMARY.md`
</output>
