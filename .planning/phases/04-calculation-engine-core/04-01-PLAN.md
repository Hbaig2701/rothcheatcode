---
phase: 04-calculation-engine-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/calculations/types.ts
  - lib/data/rmd-factors.ts
  - lib/data/irmaa-brackets.ts
  - lib/data/federal-brackets-2026.ts
  - lib/data/standard-deductions.ts
  - lib/data/federal-poverty.ts
  - lib/calculations/utils/money.ts
  - lib/calculations/utils/age.ts
autonomous: true

must_haves:
  truths:
    - "RMD factors exist for ages 72-120 matching IRS Uniform Lifetime Table"
    - "IRMAA brackets exist with 2026 thresholds for both Part B and Part D"
    - "Federal tax brackets exist for all 4 filing statuses with proper cent values"
    - "Standard deductions exist for all filing statuses including senior additions"
    - "Federal poverty level data exists for ACA calculations"
  artifacts:
    - path: "lib/calculations/types.ts"
      provides: "All calculation input/output types"
      exports: ["SimulationInput", "YearlyResult", "SimulationResult", "FederalTaxInput", "RMDInput"]
    - path: "lib/data/rmd-factors.ts"
      provides: "Uniform Lifetime Table for RMD calculations"
      contains: "UNIFORM_LIFETIME_TABLE"
    - path: "lib/data/irmaa-brackets.ts"
      provides: "Medicare IRMAA surcharge thresholds"
      contains: "IRMAA_TIERS_2026"
    - path: "lib/data/federal-brackets-2026.ts"
      provides: "Complete federal tax brackets for progressive calculation"
      exports: ["FEDERAL_BRACKETS_2026", "getFederalBrackets"]
    - path: "lib/calculations/utils/money.ts"
      provides: "Cents/dollars conversion utilities"
      exports: ["centsToDollars", "dollarsToCents"]
  key_links:
    - from: "lib/calculations/types.ts"
      to: "lib/types/client.ts"
      via: "FilingStatus import"
      pattern: "import.*Client.*from"
---

<objective>
Create all reference data tables and calculation types for the Roth conversion engine.

Purpose: Establishes the foundation for all tax and projection calculations with accurate 2026 tax data.
Output: Type definitions, reference data modules, and utility functions ready for calculation modules.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-calculation-engine-core/04-RESEARCH.md

@lib/types/client.ts
@lib/data/states.ts
@lib/data/federal-brackets.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create calculation types and utility functions</name>
  <files>
    lib/calculations/types.ts
    lib/calculations/utils/money.ts
    lib/calculations/utils/age.ts
  </files>
  <action>
Create the calculation types file at `lib/calculations/types.ts`:

1. Import `Client` type from `lib/types/client.ts`
2. Create `FilingStatus` type alias from Client's filing_status field
3. Define all calculation input/output interfaces:
   - `TaxBracket`: { lower: number, upper: number, rate: number } - values in cents
   - `FederalTaxInput`: { taxableIncome: number, filingStatus: FilingStatus, taxYear: number }
   - `FederalTaxResult`: { totalTax: number, effectiveRate: number, marginalBracket: number, bracketBreakdown: BracketAmount[] }
   - `BracketAmount`: { rate: number, amount: number }
   - `RMDInput`: { age: number, traditionalBalance: number, birthYear: number }
   - `RMDResult`: { rmdRequired: boolean, rmdAmount: number, distributionPeriod: number }
   - `NIITInput`: { magi: number, netInvestmentIncome: number, filingStatus: FilingStatus }
   - `NIITResult`: { applies: boolean, taxAmount: number, thresholdExcess: number }
   - `SSTaxInput`: { ssBenefits: number, otherIncome: number, taxExemptInterest: number, filingStatus: FilingStatus }
   - `SSTaxResult`: { taxableAmount: number, taxablePercent: number, provisionalIncome: number }
   - `IRMAAInput`: { magi: number, filingStatus: FilingStatus, hasPartD: boolean }
   - `IRMAAResult`: { tier: number, monthlyPartB: number, monthlyPartD: number, annualSurcharge: number }
   - `StateTaxInput`: { taxableIncome: number, state: string, filingStatus: FilingStatus }
   - `StateTaxResult`: { totalTax: number, effectiveRate: number }
   - `YearlyResult`: Complete annual projection snapshot (year, age, all balances, all taxes, netWorth)
   - `SimulationInput`: { client: Client, startYear: number, endYear: number }
   - `SimulationResult`: { baseline: YearlyResult[], blueprint: YearlyResult[], breakEvenAge: number | null, totalTaxSavings: number, heirBenefit: number }

Create utility file `lib/calculations/utils/money.ts`:
- `centsToDollars(cents: number): number` - converts cents to dollars for display
- `dollarsToCents(dollars: number): number` - converts dollars to cents for storage
- `formatCurrency(cents: number): string` - formats cents as "$X,XXX.XX"

Create utility file `lib/calculations/utils/age.ts`:
- `calculateAge(dob: string, asOfYear: number): number` - calculates age from DOB string
- `getRMDStartAge(birthYear: number): number` - returns 73 for 1951-1959, 75 for 1960+
- `calculateYearFromAge(dob: string, targetAge: number): number` - calculates year when person reaches targetAge
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile with no errors.
Verify files exist: `ls lib/calculations/types.ts lib/calculations/utils/money.ts lib/calculations/utils/age.ts`
  </verify>
  <done>
All calculation types exported from types.ts. Money and age utilities ready for use.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RMD, IRMAA, and Federal Poverty Level reference data</name>
  <files>
    lib/data/rmd-factors.ts
    lib/data/irmaa-brackets.ts
    lib/data/federal-poverty.ts
  </files>
  <action>
Create `lib/data/rmd-factors.ts`:
- Export `UNIFORM_LIFETIME_TABLE: Record<number, number>` with ages 72-120 and their distribution periods
- Use exact IRS Publication 590-B values from research:
  ```
  72: 27.4, 73: 26.5, 74: 25.5, 75: 24.6, 76: 23.7, 77: 22.9,
  78: 22.0, 79: 21.1, 80: 20.2, 81: 19.4, 82: 18.5, 83: 17.7,
  84: 16.8, 85: 16.0, 86: 15.2, 87: 14.4, 88: 13.7, 89: 12.9,
  90: 12.2, 91: 11.5, 92: 10.8, 93: 10.1, 94: 9.5, 95: 8.9,
  96: 8.4, 97: 7.8, 98: 7.3, 99: 6.8, 100: 6.4, 101: 6.0,
  102: 5.6, 103: 5.2, 104: 4.9, 105: 4.6, 106: 4.3, 107: 4.1,
  108: 3.9, 109: 3.7, 110: 3.5, 111: 3.4, 112: 3.3, 113: 3.1,
  114: 3.0, 115: 2.9, 116: 2.8, 117: 2.7, 118: 2.5, 119: 2.3, 120: 2.0
  ```
- Add `getDistributionPeriod(age: number): number` helper that caps at 120

Create `lib/data/irmaa-brackets.ts`:
- Define `IRMAATier` interface: { singleLower, singleUpper, jointLower, jointUpper, partBMonthly, partDMonthly } - all in cents
- Export `IRMAA_TIERS_2026: IRMAATier[]` with 6 tiers from research (standard through >$500k/$750k)
- All monetary values in cents (e.g., $202.90 = 20290)
- Add `getIRMAATier(magi: number, isJoint: boolean): IRMAATier` helper

Create `lib/data/federal-poverty.ts`:
- Export `FPL_2025` object with contiguous, alaska, hawaii rates (base and perPerson) in cents
- Export `getFPL(householdSize: number, state: string): number`
- Export `getACASubsidyCutoff(householdSize: number, state: string): number` (400% FPL)
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile with no errors.
Verify: `grep "UNIFORM_LIFETIME_TABLE" lib/data/rmd-factors.ts` shows table exists.
Verify: `grep "IRMAA_TIERS_2026" lib/data/irmaa-brackets.ts` shows tiers exist.
  </verify>
  <done>
RMD factors table complete for ages 72-120. IRMAA brackets ready with 2026 thresholds. FPL data ready for ACA calculations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive federal tax brackets and standard deductions</name>
  <files>
    lib/data/federal-brackets-2026.ts
    lib/data/standard-deductions.ts
  </files>
  <action>
Create `lib/data/federal-brackets-2026.ts`:
- Import `TaxBracket` from `lib/calculations/types.ts`
- Export `FEDERAL_BRACKETS_2026` object with keys: single, married_filing_jointly, married_filing_separately, head_of_household
- Each contains array of TaxBracket with lower/upper/rate (cents for thresholds, percentage for rate)
- Use exact values from research for all 7 brackets per filing status
- Top bracket uses `Infinity` for upper limit
- Export `getFederalBrackets(year: number, status: string): TaxBracket[]` function that:
  - Returns base brackets for 2026
  - For future years, applies 2.7% inflation factor to bracket thresholds (not rates)
  - Rounds inflated thresholds to nearest 100 cents ($1)

Create `lib/data/standard-deductions.ts`:
- Export `STANDARD_DEDUCTIONS_2026` object with:
  - single: 1610000 (cents)
  - married_filing_jointly: 3220000
  - married_filing_separately: 1610000
  - head_of_household: 2415000
  - senior_single_additional: 205000 (additional for 65+)
  - senior_married_additional: 165000 (per spouse 65+)
- Export `getStandardDeduction(status: string, age: number, spouseAge?: number): number` helper
  - Adds senior bonus if age >= 65
  - For married, checks both ages and adds 1-2 senior bonuses
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile with no errors.
Test bracket retrieval: Check that `getFederalBrackets(2026, 'single')` returns 7 brackets.
Test inflation: `getFederalBrackets(2027, 'single')[0].upper` should be ~1.027x the 2026 value.
  </verify>
  <done>
Federal brackets complete for 2026 with inflation adjustment for future years. Standard deductions ready with senior bonuses.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes
2. All 8 files exist in lib/calculations/ and lib/data/
3. Types export correctly: `import { SimulationResult } from '@/lib/calculations/types'` works
4. Reference data accessible: `import { UNIFORM_LIFETIME_TABLE } from '@/lib/data/rmd-factors'` works
</verification>

<success_criteria>
- All calculation types defined and exported
- RMD factors match IRS Uniform Lifetime Table exactly
- IRMAA brackets match 2026 published values
- Federal brackets support all 4 filing statuses
- Standard deductions include senior bonus calculations
- FPL data ready for ACA calculations
- All files pass TypeScript compilation
</success_criteria>

<output>
After completion, create `.planning/phases/04-calculation-engine-core/04-01-SUMMARY.md`
</output>
