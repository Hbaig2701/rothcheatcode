---
phase: 08-advanced-features
plan: 05
type: execute
wave: 3
depends_on: ["08-01", "08-03"]
files_modified:
  - components/results/breakeven-chart.tsx
  - components/results/sensitivity-chart.tsx
  - lib/calculations/transforms.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Breakeven chart shows all crossover points with markers"
    - "Breakeven chart highlights sustained breakeven age"
    - "Sensitivity chart displays all 7 scenarios as separate lines"
    - "Base Case line is visually emphasized (thicker, solid)"
  artifacts:
    - path: "components/results/breakeven-chart.tsx"
      provides: "Enhanced breakeven visualization with multiple crossover markers"
      exports: ["BreakevenChart"]
    - path: "components/results/sensitivity-chart.tsx"
      provides: "Multi-scenario sensitivity fan chart"
      exports: ["SensitivityChart"]
    - path: "lib/calculations/transforms.ts"
      provides: "Chart data transformation utilities"
      exports: ["transformToSensitivityChartData"]
  key_links:
    - from: "components/results/breakeven-chart.tsx"
      to: "recharts"
      via: "LineChart, ReferenceLine, ReferenceArea imports"
      pattern: "import.*ReferenceLine.*from.*recharts"
    - from: "components/results/sensitivity-chart.tsx"
      to: "lib/calculations/analysis/sensitivity.ts"
      via: "uses SCENARIO_COLORS for line colors"
      pattern: "SCENARIO_COLORS|getScenarioColor"
---

<objective>
Create enhanced visualization components for breakeven analysis and sensitivity analysis using Recharts.

Purpose: Display rich interactive charts showing multiple breakeven crossover points and sensitivity scenario comparisons, helping advisors communicate uncertainty and outcomes to clients.

Output: BreakevenChart component with crossover markers and SensitivityChart component with 7 scenario lines.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-advanced-features/08-RESEARCH.md

# Existing chart patterns
@components/results/wealth-chart.tsx
@components/results/chart-tooltip.tsx
@lib/calculations/transforms.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create enhanced BreakevenChart component</name>
  <files>components/results/breakeven-chart.tsx</files>
  <action>
Create `components/results/breakeven-chart.tsx`:

```typescript
'use client';

import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  ReferenceLine,
  ReferenceArea,
} from 'recharts';
import { ChartTooltip } from './chart-tooltip';
import type { ChartDataPoint } from '@/lib/calculations/transforms';
import type { BreakEvenAnalysis, CrossoverPoint } from '@/lib/calculations/analysis/types';
import { formatAxisValue } from '@/lib/calculations/transforms';

interface BreakevenChartProps {
  data: ChartDataPoint[];
  analysis: BreakEvenAnalysis;
}

/**
 * Get color for crossover marker based on direction
 */
function getCrossoverColor(direction: CrossoverPoint['direction']): string {
  return direction === 'blueprint_ahead' ? '#22c55e' : '#ef4444'; // green or red
}

/**
 * Enhanced breakeven chart showing:
 * - Baseline vs Blueprint wealth lines
 * - All crossover points marked
 * - Sustained breakeven highlighted
 * - Net benefit annotation
 */
export function BreakevenChart({ data, analysis }: BreakevenChartProps) {
  const {
    simpleBreakEven,
    sustainedBreakEven,
    crossoverPoints,
    netBenefit,
  } = analysis;

  // Format net benefit for display
  const netBenefitFormatted = (netBenefit / 100).toLocaleString('en-US', {
    style: 'currency',
    currency: 'USD',
    maximumFractionDigits: 0,
  });

  const isPositive = netBenefit > 0;

  return (
    <div className="space-y-2">
      {/* Summary stats */}
      <div className="flex flex-wrap gap-4 text-sm mb-4">
        {simpleBreakEven && (
          <div className="flex items-center gap-2">
            <span className="text-muted-foreground">First Breakeven:</span>
            <span className="font-medium">Age {simpleBreakEven}</span>
          </div>
        )}
        {sustainedBreakEven && sustainedBreakEven !== simpleBreakEven && (
          <div className="flex items-center gap-2">
            <span className="text-muted-foreground">Sustained Breakeven:</span>
            <span className="font-medium text-green-600">Age {sustainedBreakEven}</span>
          </div>
        )}
        <div className="flex items-center gap-2">
          <span className="text-muted-foreground">Net Benefit:</span>
          <span className={`font-medium ${isPositive ? 'text-green-600' : 'text-red-600'}`}>
            {isPositive ? '+' : ''}{netBenefitFormatted}
          </span>
        </div>
      </div>

      {/* Chart */}
      <div className="h-[400px] w-full">
        <ResponsiveContainer width="100%" height="100%">
          <LineChart
            data={data}
            margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
          >
            <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
            <XAxis
              dataKey="age"
              label={{ value: 'Age', position: 'insideBottom', offset: -5 }}
              tick={{ fontSize: 12 }}
            />
            <YAxis
              tickFormatter={formatAxisValue}
              width={70}
              tick={{ fontSize: 12 }}
            />
            <Tooltip content={<ChartTooltip />} />
            <Legend verticalAlign="top" height={36} />

            {/* Baseline line - gray */}
            <Line
              type="monotone"
              dataKey="baseline"
              name="Baseline (No Conversion)"
              stroke="#6b7280"
              strokeWidth={2}
              dot={false}
              activeDot={{ r: 6 }}
            />

            {/* Blueprint line - blue */}
            <Line
              type="monotone"
              dataKey="blueprint"
              name="Blueprint (Roth Conversion)"
              stroke="#3b82f6"
              strokeWidth={2}
              dot={false}
              activeDot={{ r: 6 }}
            />

            {/* Sustained breakeven marker - green dashed line (priority) */}
            {sustainedBreakEven && (
              <ReferenceLine
                x={sustainedBreakEven}
                stroke="#22c55e"
                strokeDasharray="5 5"
                strokeWidth={2}
                label={{
                  value: `Sustained: Age ${sustainedBreakEven}`,
                  position: 'top',
                  fill: '#22c55e',
                  fontSize: 11,
                  fontWeight: 500,
                }}
              />
            )}

            {/* Additional crossover markers (if any beyond sustained) */}
            {crossoverPoints
              .filter(p => p.age !== sustainedBreakEven)
              .slice(0, 3) // Limit to avoid clutter
              .map((point, idx) => (
                <ReferenceLine
                  key={`crossover-${idx}`}
                  x={point.age}
                  stroke={getCrossoverColor(point.direction)}
                  strokeDasharray="3 3"
                  strokeWidth={1}
                  strokeOpacity={0.6}
                />
              ))}

            {/* Shade area where blueprint is ahead (if sustained breakeven exists) */}
            {sustainedBreakEven && data.length > 0 && (
              <ReferenceArea
                x1={sustainedBreakEven}
                x2={data[data.length - 1].age}
                fill="#22c55e"
                fillOpacity={0.1}
              />
            )}
          </LineChart>
        </ResponsiveContainer>
      </div>

      {/* Crossover legend */}
      {crossoverPoints.length > 1 && (
        <div className="text-xs text-muted-foreground mt-2">
          <span className="font-medium">{crossoverPoints.length} crossover points detected.</span>
          {' '}The lines cross multiple times before the sustained breakeven.
        </div>
      )}
    </div>
  );
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm component compiles.
Verify imports from recharts include ReferenceLine, ReferenceArea.
  </verify>
  <done>
BreakevenChart displays baseline vs blueprint with sustained breakeven marker, additional crossover indicators, shaded benefit area, and summary statistics.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SensitivityChart component and update transforms</name>
  <files>
    lib/calculations/transforms.ts
    components/results/sensitivity-chart.tsx
  </files>
  <action>
**Add to lib/calculations/transforms.ts** (append to existing file):

```typescript
import type { SensitivityResult } from './analysis/types';

/**
 * Transform sensitivity results into chart-ready format
 * Merges all scenarios into single dataset keyed by age
 */
export interface SensitivityChartPoint {
  age: number;
  [scenarioName: string]: number; // Dynamic keys for each scenario
}

export function transformToSensitivityChartData(
  result: SensitivityResult
): SensitivityChartPoint[] {
  const ageMap = new Map<number, SensitivityChartPoint>();

  // Build map of age -> scenario values
  for (const [name, scenario] of Object.entries(result.scenarios)) {
    for (const yearData of scenario.blueprint) {
      const existing = ageMap.get(yearData.age);
      if (existing) {
        existing[name] = yearData.netWorth;
      } else {
        ageMap.set(yearData.age, {
          age: yearData.age,
          [name]: yearData.netWorth,
        });
      }
    }
  }

  // Convert to sorted array
  return Array.from(ageMap.values()).sort((a, b) => a.age - b.age);
}
```

**Create components/results/sensitivity-chart.tsx**:

```typescript
'use client';

import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
} from 'recharts';
import type { SensitivityResult } from '@/lib/calculations/analysis/types';
import {
  transformToSensitivityChartData,
  formatAxisValue,
} from '@/lib/calculations/transforms';
import { SCENARIO_COLORS, formatSensitivitySummary } from '@/lib/calculations/analysis/sensitivity';

interface SensitivityChartProps {
  result: SensitivityResult;
}

/**
 * Custom tooltip for sensitivity chart
 * Shows all scenario values at the hovered age
 */
function SensitivityTooltip({ active, payload, label }: any) {
  if (!active || !payload?.length) return null;

  return (
    <div className="bg-popover border rounded-lg shadow-lg p-3 text-sm">
      <p className="font-medium mb-2">Age {label}</p>
      <div className="space-y-1">
        {payload
          .sort((a: any, b: any) => b.value - a.value)
          .map((entry: any) => (
            <div key={entry.dataKey} className="flex items-center justify-between gap-4">
              <div className="flex items-center gap-2">
                <div
                  className="w-3 h-3 rounded-full"
                  style={{ backgroundColor: entry.stroke }}
                />
                <span className="text-muted-foreground">{entry.dataKey}</span>
              </div>
              <span className="font-medium">
                {(entry.value / 100).toLocaleString('en-US', {
                  style: 'currency',
                  currency: 'USD',
                  maximumFractionDigits: 0,
                })}
              </span>
            </div>
          ))}
      </div>
    </div>
  );
}

/**
 * Multi-scenario sensitivity fan chart
 * Displays all 7 scenarios with Base Case emphasized
 */
export function SensitivityChart({ result }: SensitivityChartProps) {
  const chartData = transformToSensitivityChartData(result);
  const summary = formatSensitivitySummary(result);
  const scenarioNames = Object.keys(result.scenarios);

  return (
    <div className="space-y-4">
      {/* Summary stats */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
        <div>
          <span className="text-muted-foreground block">Breakeven Range</span>
          <span className="font-medium">{summary.breakEvenRange}</span>
        </div>
        <div>
          <span className="text-muted-foreground block">Ending Wealth Range</span>
          <span className="font-medium">{summary.wealthRange}</span>
        </div>
        <div>
          <span className="text-muted-foreground block">Best Scenario</span>
          <span className="font-medium text-green-600">{summary.bestCase}</span>
        </div>
        <div>
          <span className="text-muted-foreground block">Worst Scenario</span>
          <span className="font-medium text-red-600">{summary.worstCase}</span>
        </div>
      </div>

      {/* Chart */}
      <div className="h-[400px] w-full">
        <ResponsiveContainer width="100%" height="100%">
          <LineChart
            data={chartData}
            margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
          >
            <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
            <XAxis
              dataKey="age"
              label={{ value: 'Age', position: 'insideBottom', offset: -5 }}
              tick={{ fontSize: 12 }}
            />
            <YAxis
              tickFormatter={formatAxisValue}
              width={80}
              tick={{ fontSize: 12 }}
            />
            <Tooltip content={<SensitivityTooltip />} />
            <Legend
              verticalAlign="top"
              height={48}
              wrapperStyle={{ paddingBottom: 10 }}
            />

            {/* Render lines for each scenario */}
            {scenarioNames.map(name => (
              <Line
                key={name}
                type="monotone"
                dataKey={name}
                name={name}
                stroke={SCENARIO_COLORS[name] ?? '#6b7280'}
                strokeWidth={name === 'Base Case' ? 3 : 1.5}
                strokeDasharray={
                  name === 'Pessimistic' || name === 'Optimistic'
                    ? '5 5'
                    : undefined
                }
                dot={false}
                activeDot={{ r: name === 'Base Case' ? 6 : 4 }}
              />
            ))}
          </LineChart>
        </ResponsiveContainer>
      </div>

      {/* Legend explanation */}
      <div className="text-xs text-muted-foreground">
        <p>
          <strong>Base Case</strong> uses {result.scenarios['Base Case'] ? '6%' : 'default'} growth.
          {' '}Pessimistic/Optimistic scenarios are shown with dashed lines.
        </p>
      </div>
    </div>
  );
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm both files compile.
Verify `SensitivityChart` renders 7 lines with different colors.
Check that `transformToSensitivityChartData` is exported from transforms.ts.
  </verify>
  <done>
SensitivityChart displays all 7 scenarios with Base Case emphasized (thicker line), Pessimistic/Optimistic dashed, and summary statistics showing ranges.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. `BreakevenChart` accepts data and analysis props
3. `BreakevenChart` renders ReferenceLine for sustained breakeven
4. `SensitivityChart` accepts SensitivityResult prop
5. `SensitivityChart` renders 7 Line components with SCENARIO_COLORS
6. `transformToSensitivityChartData` is exported from transforms.ts
7. Both charts have height of 400px (consistent with wealth-chart.tsx)
</verification>

<success_criteria>
- BreakevenChart shows baseline vs blueprint lines
- All crossover points marked with colored indicators
- Sustained breakeven has prominent green dashed line
- Area after sustained breakeven is lightly shaded green
- Summary stats show first breakeven, sustained breakeven, and net benefit
- SensitivityChart shows all 7 scenarios as separate lines
- Base Case line is thicker (strokeWidth: 3) and solid
- Pessimistic/Optimistic lines are dashed
- Each scenario has distinct color from SCENARIO_COLORS
- Summary shows breakeven range, wealth range, best/worst scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/08-advanced-features/08-05-SUMMARY.md`
</output>
