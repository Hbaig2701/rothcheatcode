---
phase: 08-advanced-features
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/calculations/scenarios/widow.ts
  - lib/calculations/analysis/widow-penalty.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Widow scenario runs simulation with single filing status"
    - "Widow scenario removes spouse Social Security"
    - "Widow penalty analysis shows bracket shift impact"
    - "Analysis returns recommended conversion increase"
  artifacts:
    - path: "lib/calculations/scenarios/widow.ts"
      provides: "Post-spouse-death scenario runner"
      exports: ["runWidowScenario"]
    - path: "lib/calculations/analysis/widow-penalty.ts"
      provides: "Widow's penalty tax impact analysis"
      exports: ["analyzeWidowPenalty", "calculateWidowTaxImpact"]
  key_links:
    - from: "lib/calculations/scenarios/widow.ts"
      to: "lib/calculations/scenarios/baseline.ts"
      via: "Reuses baseline scenario pattern with modified client"
      pattern: "runBaselineScenario|calculateFederalTax"
    - from: "lib/calculations/analysis/widow-penalty.ts"
      to: "lib/calculations/modules/federal-tax.ts"
      via: "import calculateFederalTax"
      pattern: "import.*calculateFederalTax.*from.*federal-tax"
---

<objective>
Implement widow's penalty analysis - calculate the tax impact when a married person becomes a single filer after spouse death.

Purpose: Help advisors show clients how the "widow's penalty" (losing married filing jointly brackets) affects their tax situation and why more aggressive Roth conversions may be beneficial.

Output: Widow scenario runner and penalty analysis module that compares MFJ vs single brackets.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-advanced-features/08-RESEARCH.md

# Existing patterns to follow
@lib/calculations/scenarios/baseline.ts
@lib/calculations/modules/federal-tax.ts
@lib/types/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create widow scenario runner</name>
  <files>lib/calculations/scenarios/widow.ts</files>
  <action>
Create `lib/calculations/scenarios/widow.ts` that runs a simulation assuming the spouse has passed:

```typescript
import type { Client } from '@/lib/types/client';
import type { YearlyResult } from '../types';
import { calculateAge } from '../utils/age';
import { calculateRMD } from '../modules/rmd';
import { calculateFederalTax, calculateTaxableIncome } from '../modules/federal-tax';
import { calculateStateTax } from '../modules/state-tax';
import { calculateSSTaxableAmount } from '../modules/social-security';
import { calculateNIIT } from '../modules/niit';
import { calculateIRMAA } from '../modules/irmaa';
import { adjustForInflation } from '../modules/inflation';
import { getStandardDeduction } from '@/lib/data/standard-deductions';

export interface WidowScenarioInput {
  client: Client;
  deathYear: number;        // Year spouse passes
  projectionYears: number;  // Years to project after death
}

/**
 * Run scenario as single filer after spouse death
 * Key changes from baseline:
 * - Filing status: single
 * - No spouse Social Security
 * - Standard deduction for single filer
 * - Single filer tax brackets (compressed)
 */
export function runWidowScenario(
  input: WidowScenarioInput
): YearlyResult[] {
  const { client, deathYear, projectionYears } = input;
  const results: YearlyResult[] = [];

  const birthYear = new Date(client.date_of_birth).getFullYear();
  const growthRate = (client.growth_rate ?? 6) / 100;
  const inflationRate = (client.inflation_rate ?? 2.5) / 100;

  // Start balances - assume inherited spouse's accounts (simplified)
  let traditionalBalance = client.traditional_ira ?? 0;
  let rothBalance = client.roth_ira ?? 0;
  let taxableBalance = client.taxable_accounts ?? 0;

  // Calculate years from death year to align inflation
  const deathYearOffset = deathYear - new Date().getFullYear();

  for (let yearOffset = 0; yearOffset < projectionYears; yearOffset++) {
    const year = deathYear + yearOffset;
    const age = calculateAge(client.date_of_birth, year);
    const totalYearsFromNow = deathYearOffset + yearOffset;

    // Apply growth
    traditionalBalance += Math.round(traditionalBalance * growthRate);
    rothBalance += Math.round(rothBalance * growthRate);
    const taxableGrowth = Math.round(taxableBalance * growthRate);
    taxableBalance += taxableGrowth;

    // Calculate RMD
    const rmdResult = calculateRMD({ age, traditionalBalance, birthYear });
    const rmdAmount = rmdResult.rmdAmount;
    traditionalBalance -= rmdAmount;

    // Social Security - ONLY client's benefit, no spouse
    const ssStartAge = client.ss_start_age ?? 67;
    // Survivor could take higher of own or 100% of spouse's - simplified to own only
    const ssIncome = age >= ssStartAge
      ? adjustForInflation(client.ss_self ?? 0, totalYearsFromNow, inflationRate)
      : 0;

    // Other income (inflation adjusted from original calculation year)
    const pensionIncome = adjustForInflation(client.pension ?? 0, totalYearsFromNow, inflationRate);
    const otherIncome = adjustForInflation(client.other_income ?? 0, totalYearsFromNow, inflationRate);

    // SS taxation - NOW AS SINGLE FILER
    const ssResult = calculateSSTaxableAmount({
      ssBenefits: ssIncome,
      otherIncome: rmdAmount + pensionIncome + otherIncome,
      taxExemptInterest: 0,
      filingStatus: 'single'  // KEY CHANGE: single filer
    });

    // Gross income
    const grossIncome = rmdAmount + ssResult.taxableAmount + pensionIncome + otherIncome;

    // Deductions - SINGLE FILER (smaller deduction)
    const deductions = getStandardDeduction('single', age, undefined);
    const taxableIncome = calculateTaxableIncome(grossIncome, deductions);

    // Federal tax - SINGLE BRACKETS (compressed)
    const federalResult = calculateFederalTax({
      taxableIncome,
      filingStatus: 'single',  // KEY CHANGE
      taxYear: year
    });

    // State tax - single
    const stateResult = calculateStateTax({
      taxableIncome,
      state: client.state,
      filingStatus: 'single'
    });

    // NIIT
    const niitResult = client.include_niit
      ? calculateNIIT({
          magi: grossIncome,
          netInvestmentIncome: taxableGrowth,
          filingStatus: 'single'  // KEY CHANGE
        })
      : { applies: false, taxAmount: 0, thresholdExcess: 0 };

    // IRMAA (65+)
    const irmaaResult = age >= 65
      ? calculateIRMAA({
          magi: grossIncome,
          filingStatus: 'single',  // KEY CHANGE
          hasPartD: true
        })
      : { tier: 0, monthlyPartB: 0, monthlyPartD: 0, annualSurcharge: 0 };

    const totalTax = federalResult.totalTax + stateResult.totalTax +
                     niitResult.taxAmount + irmaaResult.annualSurcharge;
    taxableBalance -= totalTax;

    results.push({
      year,
      age,
      spouseAge: null,  // No spouse
      traditionalBalance,
      rothBalance,
      taxableBalance,
      rmdAmount,
      conversionAmount: 0,  // Widow scenario is baseline-like (no conversions)
      ssIncome,
      pensionIncome,
      otherIncome,
      totalIncome: grossIncome,
      federalTax: federalResult.totalTax,
      stateTax: stateResult.totalTax,
      niitTax: niitResult.taxAmount,
      irmaaSurcharge: irmaaResult.annualSurcharge,
      totalTax,
      taxableSS: ssResult.taxableAmount,
      netWorth: traditionalBalance + rothBalance + taxableBalance
    });
  }

  return results;
}
```

Add export to `lib/calculations/index.ts`: `export * from './scenarios/widow';`
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm types compile.
Verify `runWidowScenario` is exported from lib/calculations.
  </verify>
  <done>
Widow scenario runner simulates post-spouse-death taxes using single filer status, single deduction, and no spouse Social Security.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create widow penalty analysis module</name>
  <files>lib/calculations/analysis/widow-penalty.ts</files>
  <action>
Create `lib/calculations/analysis/widow-penalty.ts`:

```typescript
import type { Client } from '@/lib/types/client';
import type { YearlyResult, FederalTaxInput } from '../types';
import type { WidowTaxImpact, WidowAnalysisResult } from './types';
import { calculateFederalTax, calculateTaxableIncome } from '../modules/federal-tax';
import { calculateSSTaxableAmount } from '../modules/social-security';
import { getStandardDeduction } from '@/lib/data/standard-deductions';
import { runWidowScenario } from '../scenarios/widow';
import { runBaselineScenario } from '../scenarios/baseline';
import { adjustForInflation } from '../modules/inflation';
import { calculateAge } from '../utils/age';

/**
 * Calculate tax impact for a single year of married vs widow filing
 * Shows the bracket shift penalty
 */
export function calculateWidowTaxImpact(input: {
  marriedIncome: number;    // Taxable income when married (cents)
  widowIncome: number;      // Taxable income as single (cents)
  year: number;
  marriedAge: number;
  spouseAge?: number;
}): WidowTaxImpact {
  const { marriedIncome, widowIncome, year, marriedAge, spouseAge } = input;

  // Get deductions for each status
  const marriedDeduction = getStandardDeduction(
    'married_filing_jointly',
    marriedAge,
    spouseAge
  );
  const singleDeduction = getStandardDeduction('single', marriedAge, undefined);

  // Calculate taxable income after deductions
  const marriedTaxableIncome = calculateTaxableIncome(marriedIncome, marriedDeduction);
  const singleTaxableIncome = calculateTaxableIncome(widowIncome, singleDeduction);

  // Calculate taxes
  const marriedTaxResult = calculateFederalTax({
    taxableIncome: marriedTaxableIncome,
    filingStatus: 'married_filing_jointly',
    taxYear: year,
  });

  const singleTaxResult = calculateFederalTax({
    taxableIncome: singleTaxableIncome,
    filingStatus: 'single',
    taxYear: year,
  });

  return {
    marriedTax: marriedTaxResult.totalTax,
    marriedBracket: marriedTaxResult.marginalBracket,
    singleTax: singleTaxResult.totalTax,
    singleBracket: singleTaxResult.marginalBracket,
    taxIncrease: singleTaxResult.totalTax - marriedTaxResult.totalTax,
    bracketJump: singleTaxResult.marginalBracket - marriedTaxResult.marginalBracket,
  };
}

/**
 * Default death year: Use older spouse's life expectancy or 15 years out
 */
function getDefaultDeathYear(client: Client): number {
  const currentYear = new Date().getFullYear();

  // If spouse DOB provided, use spouse's life expectancy (simplified: 85 years)
  if (client.spouse_dob) {
    const spouseBirthYear = new Date(client.spouse_dob).getFullYear();
    const spouseDeathYear = spouseBirthYear + 85;
    return Math.max(currentYear + 5, spouseDeathYear); // At least 5 years out
  }

  // Default: 15 years from now
  return currentYear + 15;
}

/**
 * Full widow's penalty analysis
 * Compares married baseline vs single-filer widow scenario
 */
export function analyzeWidowPenalty(
  client: Client,
  deathYear?: number
): WidowAnalysisResult {
  // Only applicable for married filers
  if (client.filing_status !== 'married_filing_jointly') {
    throw new Error('Widow analysis only applicable for married filing jointly');
  }

  const currentYear = new Date().getFullYear();
  const resolvedDeathYear = deathYear ?? getDefaultDeathYear(client);

  // Years from now to death
  const yearsToDeathYear = resolvedDeathYear - currentYear;
  const totalProjection = client.projection_years ?? 30;

  // Run pre-death as married (baseline scenario)
  const preDeathScenario = runBaselineScenario(
    client,
    currentYear,
    Math.min(yearsToDeathYear, totalProjection)
  );

  // Run post-death as single
  const postDeathYears = totalProjection - yearsToDeathYear;
  const postDeathScenario = postDeathYears > 0
    ? runWidowScenario({
        client,
        deathYear: resolvedDeathYear,
        projectionYears: postDeathYears,
      })
    : [];

  // Calculate tax impact year by year (post-death)
  const taxImpactByYear: WidowTaxImpact[] = [];
  let totalAdditionalTax = 0;
  const inflationRate = (client.inflation_rate ?? 2.5) / 100;

  for (let i = 0; i < postDeathScenario.length; i++) {
    const widowYear = postDeathScenario[i];
    const yearsFromNow = yearsToDeathYear + i;

    // Estimate what married income would have been (with spouse SS)
    const spouseSS = adjustForInflation(
      client.ss_spouse ?? 0,
      yearsFromNow,
      inflationRate
    );
    const estimatedMarriedIncome = widowYear.totalIncome + spouseSS;

    const impact = calculateWidowTaxImpact({
      marriedIncome: estimatedMarriedIncome,
      widowIncome: widowYear.totalIncome,
      year: widowYear.year,
      marriedAge: widowYear.age,
    });

    taxImpactByYear.push(impact);
    totalAdditionalTax += impact.taxIncrease;
  }

  // Calculate recommended conversion increase
  // Goal: Pre-convert enough to reduce traditional balance and RMDs
  // Rough heuristic: Increase conversion to fill single 22% bracket instead of 12%
  const avgBracketJump = taxImpactByYear.length > 0
    ? taxImpactByYear.reduce((sum, t) => sum + t.bracketJump, 0) / taxImpactByYear.length
    : 0;

  // Simplified: recommend converting enough to stay in current bracket
  // More sophisticated: would need to model optimal conversion amounts
  const recommendedIncrease = avgBracketJump > 5
    ? Math.round(totalAdditionalTax / postDeathScenario.length) // Spread tax prepayment
    : 0;

  return {
    deathYear: resolvedDeathYear,
    preDeathScenario,
    postDeathScenario,
    taxImpactByYear,
    totalAdditionalTax,
    recommendedConversionIncrease: recommendedIncrease,
  };
}
```

Add export to `lib/calculations/index.ts`: `export * from './analysis/widow-penalty';`
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm compilation.
Verify both `analyzeWidowPenalty` and `calculateWidowTaxImpact` are exported.
  </verify>
  <done>
Widow penalty analysis compares married vs single-filer brackets, calculates total additional tax over remaining years, and suggests conversion increases to mitigate bracket compression.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. `runWidowScenario` is exported from lib/calculations
3. `analyzeWidowPenalty` and `calculateWidowTaxImpact` are exported
4. Widow scenario uses 'single' filing status throughout
5. Analysis correctly identifies bracket jumps (e.g., 12% -> 22%)
</verification>

<success_criteria>
- Widow scenario runs simulation with single filing status
- Spouse Social Security is excluded from widow scenario
- Standard deduction uses single-filer amount
- Tax brackets use single-filer (compressed) brackets
- Analysis shows year-by-year bracket shift impact
- Total additional lifetime tax is calculated
- Recommended conversion increase is provided
</success_criteria>

<output>
After completion, create `.planning/phases/08-advanced-features/08-02-SUMMARY.md`
</output>
