---
phase: 08-advanced-features
plan: 06
type: execute
wave: 3
depends_on: ["08-02", "08-04"]
files_modified:
  - components/results/widow-analysis.tsx
  - components/results/audit-panel.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Widow analysis shows bracket comparison table (MFJ vs Single)"
    - "Widow analysis displays total additional tax impact"
    - "Audit panel shows calculation history for client"
    - "Audit entries display timestamp, strategy, and key metrics"
  artifacts:
    - path: "components/results/widow-analysis.tsx"
      provides: "Widow's penalty visualization with bracket comparison"
      exports: ["WidowAnalysis"]
    - path: "components/results/audit-panel.tsx"
      provides: "Calculation history display panel"
      exports: ["AuditPanel"]
  key_links:
    - from: "components/results/widow-analysis.tsx"
      to: "lib/calculations/analysis/widow-penalty.ts"
      via: "uses WidowAnalysisResult type"
      pattern: "WidowAnalysisResult|WidowTaxImpact"
    - from: "components/results/audit-panel.tsx"
      to: "lib/audit/log.ts"
      via: "getCalculationHistory"
      pattern: "getCalculationHistory"
---

<objective>
Create visualization components for widow's penalty analysis and audit log history display.

Purpose: Enable advisors to show clients the tax impact of becoming a single filer (widow's penalty) and provide a compliance audit trail of past calculations.

Output: WidowAnalysis component showing bracket shifts and AuditPanel component showing calculation history.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-advanced-features/08-RESEARCH.md

# Existing component patterns
@components/results/stat-card.tsx
@components/results/strategy-comparison/strategy-comparison-table.tsx
@lib/calculations/analysis/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WidowAnalysis component</name>
  <files>components/results/widow-analysis.tsx</files>
  <action>
Create `components/results/widow-analysis.tsx`:

```typescript
'use client';

import { useMemo } from 'react';
import type { WidowAnalysisResult, WidowTaxImpact } from '@/lib/calculations/analysis/types';

interface WidowAnalysisProps {
  analysis: WidowAnalysisResult;
}

/**
 * Format currency from cents to dollars
 */
function formatCurrency(cents: number): string {
  return (cents / 100).toLocaleString('en-US', {
    style: 'currency',
    currency: 'USD',
    maximumFractionDigits: 0,
  });
}

/**
 * Format bracket percentage
 */
function formatBracket(rate: number): string {
  return `${rate}%`;
}

/**
 * Bracket comparison row component
 */
function BracketRow({ impact, year }: { impact: WidowTaxImpact; year: number }) {
  const isIncrease = impact.taxIncrease > 0;

  return (
    <tr className="border-b">
      <td className="py-2 px-3 text-sm">{year}</td>
      <td className="py-2 px-3 text-sm text-center">
        <span className="font-medium">{formatBracket(impact.marriedBracket)}</span>
        <span className="text-muted-foreground ml-1">
          ({formatCurrency(impact.marriedTax)})
        </span>
      </td>
      <td className="py-2 px-3 text-sm text-center">
        <span className="font-medium">{formatBracket(impact.singleBracket)}</span>
        <span className="text-muted-foreground ml-1">
          ({formatCurrency(impact.singleTax)})
        </span>
      </td>
      <td className="py-2 px-3 text-sm text-center">
        {impact.bracketJump > 0 ? (
          <span className="text-red-600 font-medium">+{impact.bracketJump}%</span>
        ) : (
          <span className="text-muted-foreground">-</span>
        )}
      </td>
      <td className={`py-2 px-3 text-sm text-right font-medium ${
        isIncrease ? 'text-red-600' : 'text-green-600'
      }`}>
        {isIncrease ? '+' : ''}{formatCurrency(impact.taxIncrease)}
      </td>
    </tr>
  );
}

/**
 * Widow's Penalty Analysis Component
 * Shows the tax impact of transitioning from MFJ to Single filing status
 */
export function WidowAnalysis({ analysis }: WidowAnalysisProps) {
  const {
    deathYear,
    taxImpactByYear,
    totalAdditionalTax,
    recommendedConversionIncrease,
    postDeathScenario,
  } = analysis;

  // Calculate average bracket jump
  const avgBracketJump = useMemo(() => {
    if (taxImpactByYear.length === 0) return 0;
    const total = taxImpactByYear.reduce((sum, t) => sum + t.bracketJump, 0);
    return Math.round(total / taxImpactByYear.length);
  }, [taxImpactByYear]);

  // Get first few years for table (limit display)
  const displayYears = taxImpactByYear.slice(0, 10);
  const hasMoreYears = taxImpactByYear.length > 10;

  return (
    <div className="space-y-6">
      {/* Summary Cards */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="bg-muted/50 rounded-lg p-4">
          <div className="text-sm text-muted-foreground">Assumed Death Year</div>
          <div className="text-2xl font-bold">{deathYear}</div>
        </div>
        <div className="bg-muted/50 rounded-lg p-4">
          <div className="text-sm text-muted-foreground">Avg Bracket Jump</div>
          <div className="text-2xl font-bold text-red-600">
            {avgBracketJump > 0 ? `+${avgBracketJump}%` : '-'}
          </div>
        </div>
        <div className="bg-muted/50 rounded-lg p-4">
          <div className="text-sm text-muted-foreground">Total Additional Tax</div>
          <div className={`text-2xl font-bold ${totalAdditionalTax > 0 ? 'text-red-600' : 'text-green-600'}`}>
            {formatCurrency(totalAdditionalTax)}
          </div>
        </div>
        <div className="bg-muted/50 rounded-lg p-4">
          <div className="text-sm text-muted-foreground">Suggested Conversion Increase</div>
          <div className="text-2xl font-bold text-blue-600">
            {recommendedConversionIncrease > 0
              ? formatCurrency(recommendedConversionIncrease) + '/yr'
              : 'None'}
          </div>
        </div>
      </div>

      {/* Explanation */}
      <div className="bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4">
        <h4 className="font-medium text-amber-800 dark:text-amber-200 mb-2">
          What is the Widow&apos;s Penalty?
        </h4>
        <p className="text-sm text-amber-700 dark:text-amber-300">
          When a spouse passes, the surviving spouse must file as Single instead of Married Filing Jointly.
          Single tax brackets are significantly narrower - for example, the 22% bracket starts at ~$48K
          for singles vs ~$97K for married couples. This &quot;bracket compression&quot; often results in
          higher taxes despite lower income.
        </p>
      </div>

      {/* Year-by-Year Comparison Table */}
      {taxImpactByYear.length > 0 && (
        <div className="border rounded-lg overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full min-w-[600px]">
              <thead className="bg-muted/50">
                <tr>
                  <th className="py-2 px-3 text-left text-sm font-medium">Year</th>
                  <th className="py-2 px-3 text-center text-sm font-medium">
                    Married (MFJ)
                  </th>
                  <th className="py-2 px-3 text-center text-sm font-medium">
                    Single (Widow)
                  </th>
                  <th className="py-2 px-3 text-center text-sm font-medium">
                    Bracket Jump
                  </th>
                  <th className="py-2 px-3 text-right text-sm font-medium">
                    Tax Difference
                  </th>
                </tr>
              </thead>
              <tbody>
                {displayYears.map((impact, idx) => (
                  <BracketRow
                    key={idx}
                    impact={impact}
                    year={deathYear + idx}
                  />
                ))}
              </tbody>
              <tfoot className="bg-muted/30">
                <tr>
                  <td colSpan={4} className="py-2 px-3 text-sm font-medium text-right">
                    {hasMoreYears
                      ? `Total (showing first 10 of ${taxImpactByYear.length} years)`
                      : 'Total'}
                  </td>
                  <td className={`py-2 px-3 text-right font-bold ${
                    totalAdditionalTax > 0 ? 'text-red-600' : 'text-green-600'
                  }`}>
                    {totalAdditionalTax > 0 ? '+' : ''}{formatCurrency(totalAdditionalTax)}
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      )}

      {/* Recommendation */}
      {recommendedConversionIncrease > 0 && (
        <div className="bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
          <h4 className="font-medium text-blue-800 dark:text-blue-200 mb-2">
            Recommendation
          </h4>
          <p className="text-sm text-blue-700 dark:text-blue-300">
            Consider increasing Roth conversions by approximately{' '}
            <strong>{formatCurrency(recommendedConversionIncrease)}</strong> per year
            to fill higher brackets now while filing jointly. This can reduce the
            widow&apos;s penalty impact by lowering future RMDs and taxable income.
          </p>
        </div>
      )}
    </div>
  );
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm component compiles.
Verify component handles empty taxImpactByYear array gracefully.
  </verify>
  <done>
WidowAnalysis component displays bracket comparison table, summary statistics, educational explanation, and conversion recommendation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AuditPanel component</name>
  <files>components/results/audit-panel.tsx</files>
  <action>
Create `components/results/audit-panel.tsx`:

```typescript
'use client';

import { useEffect, useState } from 'react';
import { createClient } from '@/lib/supabase/client';
import type { AuditLogSummary } from '@/lib/audit/types';
import { getCalculationHistory } from '@/lib/audit/log';

interface AuditPanelProps {
  clientId: string;
}

/**
 * Format currency from cents to dollars
 */
function formatCurrency(cents: number): string {
  return (cents / 100).toLocaleString('en-US', {
    style: 'currency',
    currency: 'USD',
    maximumFractionDigits: 0,
  });
}

/**
 * Format relative time (e.g., "2 hours ago")
 */
function formatRelativeTime(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);

  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;

  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined,
  });
}

/**
 * Format strategy name for display
 */
function formatStrategy(strategy: string): string {
  return strategy
    .replace(/_/g, ' ')
    .replace(/\b\w/g, c => c.toUpperCase());
}

/**
 * Audit history row component
 */
function AuditRow({ entry }: { entry: AuditLogSummary }) {
  return (
    <div className="flex items-center justify-between py-3 border-b last:border-b-0">
      <div className="flex items-center gap-4">
        {/* Timestamp */}
        <div className="text-sm text-muted-foreground w-20">
          {formatRelativeTime(entry.created_at)}
        </div>

        {/* Strategy badge */}
        <div className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
          {formatStrategy(entry.strategy)}
        </div>

        {/* Breakeven */}
        <div className="text-sm">
          {entry.break_even_age ? (
            <span>Breakeven: <strong>Age {entry.break_even_age}</strong></span>
          ) : (
            <span className="text-muted-foreground">No breakeven</span>
          )}
        </div>
      </div>

      {/* Results */}
      <div className="flex items-center gap-6 text-sm">
        <div className="text-right">
          <span className="text-muted-foreground">Tax Savings: </span>
          <span className={entry.total_tax_savings > 0 ? 'text-green-600 font-medium' : ''}>
            {formatCurrency(entry.total_tax_savings)}
          </span>
        </div>
        <div className="text-right">
          <span className="text-muted-foreground">Final Wealth: </span>
          <span className="font-medium">
            {formatCurrency(entry.blueprint_final_wealth)}
          </span>
        </div>
        <div className="text-xs text-muted-foreground w-12">
          v{entry.engine_version}
        </div>
      </div>
    </div>
  );
}

/**
 * Audit Panel Component
 * Displays calculation history for a client
 */
export function AuditPanel({ clientId }: AuditPanelProps) {
  const [history, setHistory] = useState<AuditLogSummary[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function loadHistory() {
      try {
        const supabase = createClient();
        const data = await getCalculationHistory(supabase, clientId, 20);
        setHistory(data);
      } catch (err) {
        setError('Failed to load calculation history');
        console.error('[AuditPanel] Load error:', err);
      } finally {
        setLoading(false);
      }
    }

    loadHistory();
  }, [clientId]);

  if (loading) {
    return (
      <div className="border rounded-lg p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-4 bg-muted rounded w-1/3"></div>
          <div className="h-10 bg-muted rounded"></div>
          <div className="h-10 bg-muted rounded"></div>
          <div className="h-10 bg-muted rounded"></div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="border rounded-lg p-6 text-center">
        <p className="text-sm text-red-600">{error}</p>
      </div>
    );
  }

  if (history.length === 0) {
    return (
      <div className="border rounded-lg p-6 text-center">
        <p className="text-sm text-muted-foreground">
          No calculation history yet. Run a projection to see audit logs here.
        </p>
      </div>
    );
  }

  return (
    <div className="border rounded-lg">
      {/* Header */}
      <div className="px-4 py-3 border-b bg-muted/30">
        <div className="flex items-center justify-between">
          <h3 className="font-medium">Calculation History</h3>
          <span className="text-sm text-muted-foreground">
            {history.length} calculation{history.length !== 1 ? 's' : ''}
          </span>
        </div>
      </div>

      {/* History list */}
      <div className="divide-y">
        {history.map(entry => (
          <div key={entry.id} className="px-4">
            <AuditRow entry={entry} />
          </div>
        ))}
      </div>

      {/* Footer note */}
      <div className="px-4 py-2 border-t bg-muted/20 text-xs text-muted-foreground">
        Audit logs are immutable and cannot be modified or deleted.
      </div>
    </div>
  );
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm component compiles.
Verify component handles loading and error states.
Verify component handles empty history gracefully.
  </verify>
  <done>
AuditPanel component displays calculation history with timestamps, strategy badges, key metrics, and engine version. Handles loading, error, and empty states.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. `WidowAnalysis` renders bracket comparison table
3. `WidowAnalysis` shows summary cards with key metrics
4. `AuditPanel` calls `getCalculationHistory` on mount
5. `AuditPanel` handles loading, error, and empty states
6. Both components follow existing styling patterns (muted colors, rounded-lg)
</verification>

<success_criteria>
- WidowAnalysis shows 4 summary cards: death year, avg bracket jump, total additional tax, suggested conversion increase
- WidowAnalysis displays year-by-year bracket comparison table (MFJ vs Single)
- WidowAnalysis includes educational explanation of widow's penalty
- WidowAnalysis shows recommendation when conversion increase is suggested
- AuditPanel displays list of past calculations with relative timestamps
- Each audit entry shows strategy, breakeven age, tax savings, final wealth
- AuditPanel footer notes immutability of audit logs
</success_criteria>

<output>
After completion, create `.planning/phases/08-advanced-features/08-06-SUMMARY.md`
</output>
