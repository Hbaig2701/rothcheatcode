---
phase: 08-advanced-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/calculations/analysis/types.ts
  - lib/calculations/analysis/breakeven.ts
  - lib/data/aca-percentages.ts
  - lib/calculations/modules/aca.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Breakeven analysis returns multiple crossover points"
    - "Breakeven identifies sustained breakeven age"
    - "ACA subsidy calculation uses actual applicable percentage table"
    - "ACA calculation handles 2025 enhanced credits and 2026+ cliff correctly"
  artifacts:
    - path: "lib/calculations/analysis/types.ts"
      provides: "Analysis types for breakeven and sensitivity"
      exports: ["BreakEvenAnalysis", "CrossoverPoint", "SensitivityScenario", "SensitivityResult", "WidowAnalysisResult"]
    - path: "lib/calculations/analysis/breakeven.ts"
      provides: "Multi-metric breakeven analysis"
      exports: ["analyzeBreakEven"]
    - path: "lib/data/aca-percentages.ts"
      provides: "Applicable percentage tables for 2025 and 2026+"
      exports: ["APPLICABLE_PERCENTAGES_2025", "APPLICABLE_PERCENTAGES_2026", "getApplicablePercentage"]
    - path: "lib/calculations/modules/aca.ts"
      provides: "Enhanced ACA subsidy calculation with dollar impact"
      exports: ["checkACACliff", "calculateACAImpact", "calculateACASubsidy"]
  key_links:
    - from: "lib/calculations/analysis/breakeven.ts"
      to: "lib/calculations/analysis/types.ts"
      via: "import BreakEvenAnalysis, CrossoverPoint"
      pattern: "import.*BreakEvenAnalysis.*from.*types"
    - from: "lib/calculations/modules/aca.ts"
      to: "lib/data/aca-percentages.ts"
      via: "import getApplicablePercentage"
      pattern: "import.*getApplicablePercentage.*from.*aca-percentages"
---

<objective>
Create foundation analysis types and implement enhanced breakeven analysis and ACA subsidy calculation modules.

Purpose: Establish the type system for all advanced analysis features and provide accurate financial calculations for breakeven visualization and ACA impact assessment.

Output: Analysis types file, breakeven analysis module, ACA applicable percentage data, and enhanced ACA calculation module.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-advanced-features/08-RESEARCH.md

# Existing patterns
@lib/calculations/types.ts
@lib/calculations/modules/aca.ts
@lib/data/federal-poverty.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analysis types and breakeven module</name>
  <files>
    lib/calculations/analysis/types.ts
    lib/calculations/analysis/breakeven.ts
  </files>
  <action>
Create `lib/calculations/analysis/` directory with two files:

**types.ts** - Analysis result types:
```typescript
import type { YearlyResult } from '../types';

// Breakeven Analysis Types
export interface CrossoverPoint {
  age: number;
  year: number;
  direction: 'blueprint_ahead' | 'baseline_ahead';
  wealthDifference: number; // cents
}

export interface BreakEvenAnalysis {
  simpleBreakEven: number | null;     // First crossover age
  sustainedBreakEven: number | null;  // Age when blueprint STAYS ahead
  netBenefit: number;                 // Total wealth advantage at end (cents)
  crossoverPoints: CrossoverPoint[];  // All crossover events
}

// Sensitivity Analysis Types
export interface SensitivityScenario {
  name: string;
  growthRate: number;           // percentage e.g., 6
  taxRateMultiplier: number;    // 1.0 = current law, 1.2 = +20%
}

export interface SensitivityResult {
  scenarios: Record<string, {
    baseline: YearlyResult[];
    blueprint: YearlyResult[];
    breakEvenAge: number | null;
    endingWealth: number;         // blueprint final net worth (cents)
  }>;
  breakEvenRange: {
    min: number | null;
    max: number | null;
  };
  wealthRange: {
    min: number;
    max: number;
  };
}

// Widow's Penalty Types
export interface WidowTaxImpact {
  marriedTax: number;          // cents
  marriedBracket: number;      // percentage
  singleTax: number;           // cents
  singleBracket: number;       // percentage
  taxIncrease: number;         // cents (can be negative)
  bracketJump: number;         // percentage points
}

export interface WidowAnalysisResult {
  deathYear: number;
  preDeathScenario: YearlyResult[];  // Before spouse death
  postDeathScenario: YearlyResult[]; // After as single filer
  taxImpactByYear: WidowTaxImpact[];
  totalAdditionalTax: number;         // cents over remaining years
  recommendedConversionIncrease: number; // cents/year
}
```

**breakeven.ts** - Multi-metric breakeven analysis:
```typescript
import type { YearlyResult } from '../types';
import type { BreakEvenAnalysis, CrossoverPoint } from './types';

/**
 * Find the sustained breakeven age - when blueprint STAYS ahead
 * (not just a temporary crossover)
 */
function findSustainedBreakEven(
  baseline: YearlyResult[],
  blueprint: YearlyResult[],
  crossoverPoints: CrossoverPoint[]
): number | null {
  // Find first crossover to blueprint_ahead that doesn't reverse
  for (const point of crossoverPoints) {
    if (point.direction === 'blueprint_ahead') {
      // Check if it ever crosses back
      const idx = baseline.findIndex(y => y.age === point.age);
      const reversesLater = crossoverPoints.some(
        p => p.age > point.age && p.direction === 'baseline_ahead'
      );
      if (!reversesLater) {
        return point.age;
      }
    }
  }
  return null;
}

/**
 * Analyze breakeven between baseline and blueprint scenarios
 * Returns multiple metrics for comprehensive understanding
 */
export function analyzeBreakEven(
  baseline: YearlyResult[],
  blueprint: YearlyResult[]
): BreakEvenAnalysis {
  const crossoverPoints: CrossoverPoint[] = [];
  let lastDirection: 'blueprint_ahead' | 'baseline_ahead' | null = null;

  for (let i = 0; i < baseline.length; i++) {
    const diff = blueprint[i].netWorth - baseline[i].netWorth;
    const currentDirection: 'blueprint_ahead' | 'baseline_ahead' =
      diff > 0 ? 'blueprint_ahead' : 'baseline_ahead';

    // Detect crossover (direction change)
    if (lastDirection !== null && currentDirection !== lastDirection) {
      crossoverPoints.push({
        age: blueprint[i].age,
        year: blueprint[i].year,
        direction: currentDirection,
        wealthDifference: diff,
      });
    }
    lastDirection = currentDirection;
  }

  // Simple breakeven: first time blueprint goes ahead
  const simpleBreakEven = crossoverPoints.find(
    p => p.direction === 'blueprint_ahead'
  )?.age ?? null;

  // Sustained breakeven: when it stays ahead
  const sustainedBreakEven = findSustainedBreakEven(
    baseline, blueprint, crossoverPoints
  );

  // Net benefit: final difference
  const lastBaseline = baseline[baseline.length - 1];
  const lastBlueprint = blueprint[blueprint.length - 1];
  const netBenefit = lastBlueprint.netWorth - lastBaseline.netWorth;

  return {
    simpleBreakEven,
    sustainedBreakEven,
    netBenefit,
    crossoverPoints,
  };
}
```

Export from index: Add `export * from './analysis/types';` and `export * from './analysis/breakeven';` to `lib/calculations/index.ts`.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify types compile without errors.
Check that `lib/calculations/analysis/breakeven.ts` exports `analyzeBreakEven`.
  </verify>
  <done>
Analysis types defined for breakeven, sensitivity, and widow analysis. Breakeven module computes simple, sustained, and all crossover points.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ACA applicable percentage data and enhance ACA module</name>
  <files>
    lib/data/aca-percentages.ts
    lib/calculations/modules/aca.ts
  </files>
  <action>
**lib/data/aca-percentages.ts** - Applicable percentage lookup tables:
```typescript
/**
 * ACA Applicable Percentage Tables
 * Used to calculate expected premium contribution as % of income
 * Source: IRS Rev. Proc. 2024-35, Healthcare.gov
 */

export interface ApplicablePercentBracket {
  minFPL: number;   // Starting FPL percentage
  maxFPL: number;   // Ending FPL percentage
  minPct: number | null;  // Starting applicable percentage
  maxPct: number | null;  // Ending applicable percentage (null = no subsidy)
}

/**
 * 2025 Enhanced Credits (ARPA/IRA extended)
 * No cliff at 400% - caps at 8.5% for all income levels above 400% FPL
 */
export const APPLICABLE_PERCENTAGES_2025: ApplicablePercentBracket[] = [
  { minFPL: 0, maxFPL: 150, minPct: 0, maxPct: 0 },
  { minFPL: 150, maxFPL: 200, minPct: 0, maxPct: 2 },
  { minFPL: 200, maxFPL: 250, minPct: 2, maxPct: 4 },
  { minFPL: 250, maxFPL: 300, minPct: 4, maxPct: 6 },
  { minFPL: 300, maxFPL: 400, minPct: 6, maxPct: 8.5 },
  { minFPL: 400, maxFPL: Infinity, minPct: 8.5, maxPct: 8.5 }, // Capped, no cliff
];

/**
 * 2026+ Standard Credits (if enhanced credits expire)
 * Hard cliff at 400% FPL - no subsidy above that
 */
export const APPLICABLE_PERCENTAGES_2026: ApplicablePercentBracket[] = [
  { minFPL: 100, maxFPL: 133, minPct: 2.10, maxPct: 2.10 },
  { minFPL: 133, maxFPL: 150, minPct: 3.14, maxPct: 4.19 },
  { minFPL: 150, maxFPL: 200, minPct: 4.19, maxPct: 6.52 },
  { minFPL: 200, maxFPL: 250, minPct: 6.52, maxPct: 8.33 },
  { minFPL: 250, maxFPL: 300, minPct: 8.33, maxPct: 9.83 },
  { minFPL: 300, maxFPL: 400, minPct: 9.83, maxPct: 9.83 },
  { minFPL: 400, maxFPL: Infinity, minPct: null, maxPct: null }, // NO SUBSIDY
];

/**
 * Estimated benchmark premiums by age (annual, in cents)
 * SLCSP (Second Lowest Cost Silver Plan) averages
 * Source: KFF analysis of marketplace data
 */
export const ESTIMATED_BENCHMARKS: Record<string, number> = {
  '40': 480000,   // ~$4,800/year for 40yo
  '50': 660000,   // ~$6,600/year for 50yo
  '60': 960000,   // ~$9,600/year for 60yo
  '64': 1080000,  // ~$10,800/year for 64yo
  'couple_60': 1920000, // ~$19,200/year for couple age 60
};

/**
 * Get applicable percentage for a given FPL percentage and year
 * Uses linear interpolation within brackets
 * Returns null if above cliff (2026+) - indicates no subsidy
 */
export function getApplicablePercentage(
  fplPercent: number,
  year: number
): number | null {
  const table = year <= 2025
    ? APPLICABLE_PERCENTAGES_2025
    : APPLICABLE_PERCENTAGES_2026;

  const bracket = table.find(
    b => fplPercent >= b.minFPL && fplPercent < b.maxFPL
  );

  if (!bracket || bracket.minPct === null) {
    return null; // Above cliff or below minimum
  }

  // Handle single-value brackets
  if (bracket.minPct === bracket.maxPct) {
    return bracket.minPct;
  }

  // Linear interpolation within bracket
  const range = bracket.maxFPL - bracket.minFPL;
  const position = (fplPercent - bracket.minFPL) / range;
  return bracket.minPct + position * (bracket.maxPct! - bracket.minPct);
}

/**
 * Get estimated benchmark premium based on age
 * Returns annual amount in cents
 */
export function getEstimatedBenchmark(age: number, isCouple: boolean): number {
  if (isCouple && age >= 60) return ESTIMATED_BENCHMARKS['couple_60'];
  if (age >= 64) return ESTIMATED_BENCHMARKS['64'];
  if (age >= 60) return ESTIMATED_BENCHMARKS['60'];
  if (age >= 50) return ESTIMATED_BENCHMARKS['50'];
  return ESTIMATED_BENCHMARKS['40'];
}
```

**lib/calculations/modules/aca.ts** - Enhance existing module (keep existing functions, add new):
```typescript
import { getFPL, getACASubsidyCutoff } from '@/lib/data/federal-poverty';
import { getApplicablePercentage, getEstimatedBenchmark } from '@/lib/data/aca-percentages';

// Keep existing interfaces ACAInput and ACAResult

// NEW: Detailed subsidy calculation result
export interface ACASubsidyResult {
  eligible: boolean;            // Under 65, income in range
  fplPercent: number;           // Income as % of FPL
  applicablePercent: number | null; // Required contribution %
  expectedContribution: number; // What household should pay (cents)
  benchmarkPremium: number;     // Estimated SLCSP (cents)
  subsidyAmount: number;        // Benchmark - contribution (cents)
  isAtCliff: boolean;           // Above 400% in 2026+
  year: number;
}

// Keep existing checkACACliff function

// Keep existing calculateACAImpact function

/**
 * NEW: Calculate actual ACA subsidy amount
 * Uses applicable percentage table for precise calculation
 */
export function calculateACASubsidy(input: {
  magi: number;           // cents
  householdSize: number;
  state: string;
  age: number;
  year: number;
  isCouple?: boolean;
}): ACASubsidyResult {
  const { magi, householdSize, state, age, year, isCouple = false } = input;

  // Medicare eligible - no ACA
  if (age >= 65) {
    return {
      eligible: false,
      fplPercent: 0,
      applicablePercent: null,
      expectedContribution: 0,
      benchmarkPremium: 0,
      subsidyAmount: 0,
      isAtCliff: false,
      year,
    };
  }

  const fpl = getFPL(householdSize, state);
  const fplPercent = (magi / fpl) * 100;
  const applicablePercent = getApplicablePercentage(fplPercent, year);

  // Above cliff (2026+ only - returns null)
  if (applicablePercent === null) {
    return {
      eligible: true,
      fplPercent,
      applicablePercent: null,
      expectedContribution: 0,
      benchmarkPremium: getEstimatedBenchmark(age, isCouple),
      subsidyAmount: 0,
      isAtCliff: true,
      year,
    };
  }

  // Calculate expected contribution and subsidy
  const expectedContribution = Math.round(magi * (applicablePercent / 100));
  const benchmarkPremium = getEstimatedBenchmark(age, isCouple);
  const subsidyAmount = Math.max(0, benchmarkPremium - expectedContribution);

  return {
    eligible: true,
    fplPercent,
    applicablePercent,
    expectedContribution,
    benchmarkPremium,
    subsidyAmount,
    isAtCliff: false,
    year,
  };
}

/**
 * NEW: Calculate conversion impact on subsidy
 * Returns change in subsidy amount due to conversion
 */
export function calculateConversionSubsidyImpact(input: {
  baseMAGI: number;       // MAGI without conversion (cents)
  conversionAmount: number;
  householdSize: number;
  state: string;
  age: number;
  year: number;
  isCouple?: boolean;
}): {
  beforeSubsidy: number;
  afterSubsidy: number;
  subsidyLoss: number;
  crossesCliff: boolean;
} {
  const { baseMAGI, conversionAmount, ...rest } = input;

  const before = calculateACASubsidy({ magi: baseMAGI, ...rest });
  const after = calculateACASubsidy({ magi: baseMAGI + conversionAmount, ...rest });

  return {
    beforeSubsidy: before.subsidyAmount,
    afterSubsidy: after.subsidyAmount,
    subsidyLoss: before.subsidyAmount - after.subsidyAmount,
    crossesCliff: !before.isAtCliff && after.isAtCliff,
  };
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify all types compile.
Run `grep -r "calculateACASubsidy" lib/` to confirm export is available.
  </verify>
  <done>
ACA applicable percentage tables created for 2025 (no cliff) and 2026+ (cliff at 400%). Enhanced ACA module calculates actual dollar subsidies and conversion impact.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. `lib/calculations/analysis/types.ts` exports all analysis types
3. `lib/calculations/analysis/breakeven.ts` exports `analyzeBreakEven`
4. `lib/data/aca-percentages.ts` exports percentage tables and lookup function
5. `lib/calculations/modules/aca.ts` exports `calculateACASubsidy` and `calculateConversionSubsidyImpact`
</verification>

<success_criteria>
- Analysis types file defines BreakEvenAnalysis, SensitivityResult, and WidowAnalysisResult
- Breakeven module returns simpleBreakEven, sustainedBreakEven, netBenefit, and crossoverPoints
- ACA module uses actual applicable percentage tables instead of rough estimate
- ACA correctly handles 2025 enhanced credits (no cliff) vs 2026+ (cliff at 400%)
- All exports added to lib/calculations/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/08-advanced-features/08-01-SUMMARY.md`
</output>
