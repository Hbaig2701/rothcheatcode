---
phase: 08-advanced-features
plan: 07
type: execute
wave: 4
depends_on: ["08-05", "08-06"]
files_modified:
  - app/api/clients/[id]/analysis/route.ts
  - lib/queries/analysis.ts
  - components/results/advanced-features-section.tsx
  - app/(protected)/clients/[id]/results/page.tsx
autonomous: false
user_setup: []

must_haves:
  truths:
    - "API endpoint returns breakeven, sensitivity, and widow analysis"
    - "Results page shows new Advanced Features tab/section"
    - "Breakeven chart, sensitivity chart, and widow analysis are displayed"
    - "Audit panel is visible in results page"
    - "Analysis runs only when client has relevant flags enabled"
  artifacts:
    - path: "app/api/clients/[id]/analysis/route.ts"
      provides: "API endpoint for advanced analysis features"
      exports: ["GET"]
    - path: "lib/queries/analysis.ts"
      provides: "TanStack Query hooks for analysis data"
      exports: ["useAnalysis"]
    - path: "components/results/advanced-features-section.tsx"
      provides: "Container component for all advanced features"
      exports: ["AdvancedFeaturesSection"]
    - path: "app/(protected)/clients/[id]/results/page.tsx"
      provides: "Results page with advanced features integration"
      contains: "AdvancedFeaturesSection"
  key_links:
    - from: "app/api/clients/[id]/analysis/route.ts"
      to: "lib/calculations/analysis/*"
      via: "imports analysis functions"
      pattern: "analyzeBreakEven|runSensitivityAnalysis|analyzeWidowPenalty"
    - from: "lib/queries/analysis.ts"
      to: "app/api/clients/[id]/analysis/route.ts"
      via: "fetches from API"
      pattern: "fetch.*api/clients.*analysis"
    - from: "app/(protected)/clients/[id]/results/page.tsx"
      to: "components/results/advanced-features-section.tsx"
      via: "import AdvancedFeaturesSection"
      pattern: "import.*AdvancedFeaturesSection"
---

<objective>
Wire advanced features into the results page with API endpoint, query hooks, and container component integration.

Purpose: Make all advanced analysis features (breakeven, sensitivity, widow's penalty, audit log) accessible from the client results page.

Output: API endpoint for analysis data, TanStack Query hooks, container component, and updated results page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-advanced-features/08-RESEARCH.md

# Existing patterns
@app/api/clients/[id]/route.ts
@lib/queries/clients.ts
@lib/queries/projections.ts
@app/(protected)/clients/[id]/results/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analysis API endpoint</name>
  <files>app/api/clients/[id]/analysis/route.ts</files>
  <action>
Create `app/api/clients/[id]/analysis/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import type { Client } from '@/lib/types/client';
import { analyzeBreakEven } from '@/lib/calculations/analysis/breakeven';
import { runSensitivityAnalysis } from '@/lib/calculations/analysis/sensitivity';
import { analyzeWidowPenalty } from '@/lib/calculations/analysis/widow-penalty';
import { runSimulation, createSimulationInput } from '@/lib/calculations/engine';
import { logCalculation } from '@/lib/audit/log';

interface AnalysisResponse {
  breakeven: ReturnType<typeof analyzeBreakEven> | null;
  sensitivity: ReturnType<typeof runSensitivityAnalysis> | null;
  widow: Awaited<ReturnType<typeof analyzeWidowPenalty>> | null;
}

/**
 * GET /api/clients/[id]/analysis
 * Returns advanced analysis results for a client
 */
export async function GET(
  request: NextRequest,
  context: { params: Promise<{ id: string }> }
) {
  const { id } = await context.params;

  const supabase = await createClient();

  // Verify authentication
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // Fetch client
  const { data: client, error: clientError } = await supabase
    .from('clients')
    .select('*')
    .eq('id', id)
    .single();

  if (clientError) {
    if (clientError.code === 'PGRST116') {
      return NextResponse.json({ error: 'Client not found' }, { status: 404 });
    }
    return NextResponse.json({ error: clientError.message }, { status: 500 });
  }

  const typedClient = client as Client;

  // Track calculation time for audit
  const startTime = performance.now();

  // Run base simulation for breakeven analysis
  const simulationInput = createSimulationInput(typedClient);
  const baseResult = runSimulation(simulationInput);

  const response: AnalysisResponse = {
    breakeven: null,
    sensitivity: null,
    widow: null,
  };

  // Always compute breakeven analysis
  response.breakeven = analyzeBreakEven(baseResult.baseline, baseResult.blueprint);

  // Run sensitivity analysis if enabled
  if (typedClient.sensitivity) {
    response.sensitivity = runSensitivityAnalysis(typedClient);
  }

  // Run widow analysis if enabled and married
  if (
    typedClient.widow_analysis &&
    typedClient.filing_status === 'married_filing_jointly'
  ) {
    try {
      response.widow = analyzeWidowPenalty(typedClient);
    } catch (err) {
      console.error('[Analysis] Widow analysis error:', err);
      // Don't fail the whole request, just return null
    }
  }

  // Calculate duration and log to audit
  const durationMs = performance.now() - startTime;
  logCalculation(supabase, typedClient, baseResult, durationMs);

  return NextResponse.json(response);
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm route compiles.
Verify route follows Next.js 15 async params pattern.
  </verify>
  <done>
Analysis API endpoint returns breakeven (always), sensitivity (if enabled), and widow analysis (if enabled and married). Logs to audit on every request.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create analysis query hooks and container component</name>
  <files>
    lib/queries/analysis.ts
    components/results/advanced-features-section.tsx
  </files>
  <action>
**Create lib/queries/analysis.ts**:

```typescript
import { useQuery } from '@tanstack/react-query';
import type { BreakEvenAnalysis, SensitivityResult, WidowAnalysisResult } from '@/lib/calculations/analysis/types';

interface AnalysisResponse {
  breakeven: BreakEvenAnalysis | null;
  sensitivity: SensitivityResult | null;
  widow: WidowAnalysisResult | null;
}

/**
 * Query keys for analysis data
 */
export const analysisKeys = {
  all: ['analysis'] as const,
  client: (clientId: string) => [...analysisKeys.all, clientId] as const,
};

/**
 * Fetch analysis data for a client
 */
async function fetchAnalysis(clientId: string): Promise<AnalysisResponse> {
  const response = await fetch(`/api/clients/${clientId}/analysis`);

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'Failed to fetch analysis');
  }

  return response.json();
}

/**
 * Hook to fetch advanced analysis data
 * Includes breakeven, sensitivity, and widow analysis
 */
export function useAnalysis(clientId: string | undefined) {
  return useQuery({
    queryKey: analysisKeys.client(clientId ?? ''),
    queryFn: () => fetchAnalysis(clientId!),
    enabled: !!clientId,
    staleTime: 5 * 60 * 1000, // 5 minutes (analysis is expensive)
  });
}
```

**Create components/results/advanced-features-section.tsx**:

```typescript
'use client';

import { useState } from 'react';
import type { Client } from '@/lib/types/client';
import type { ChartDataPoint } from '@/lib/calculations/transforms';
import { useAnalysis } from '@/lib/queries/analysis';
import { BreakevenChart } from './breakeven-chart';
import { SensitivityChart } from './sensitivity-chart';
import { WidowAnalysis } from './widow-analysis';
import { AuditPanel } from './audit-panel';

interface AdvancedFeaturesSectionProps {
  client: Client;
  chartData: ChartDataPoint[];
}

type TabId = 'breakeven' | 'sensitivity' | 'widow' | 'audit';

interface Tab {
  id: TabId;
  label: string;
  enabled: boolean;
}

/**
 * Container component for all advanced analysis features
 * Shows tabs for: Breakeven, Sensitivity, Widow's Penalty, Audit Log
 */
export function AdvancedFeaturesSection({
  client,
  chartData,
}: AdvancedFeaturesSectionProps) {
  const { data: analysis, isLoading, error } = useAnalysis(client.id);

  // Determine which tabs are enabled based on client settings
  const tabs: Tab[] = [
    { id: 'breakeven', label: 'Breakeven Analysis', enabled: true },
    { id: 'sensitivity', label: 'Sensitivity', enabled: client.sensitivity },
    {
      id: 'widow',
      label: "Widow's Penalty",
      enabled: client.widow_analysis && client.filing_status === 'married_filing_jointly',
    },
    { id: 'audit', label: 'Audit Log', enabled: true },
  ];

  const enabledTabs = tabs.filter(t => t.enabled);
  const [activeTab, setActiveTab] = useState<TabId>(enabledTabs[0]?.id ?? 'breakeven');

  if (isLoading) {
    return (
      <div className="mt-8 border rounded-lg p-8">
        <div className="animate-pulse space-y-4">
          <div className="h-6 bg-muted rounded w-1/4"></div>
          <div className="h-64 bg-muted rounded"></div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="mt-8 border rounded-lg p-6 text-center">
        <p className="text-sm text-red-600">
          Failed to load analysis: {error.message}
        </p>
      </div>
    );
  }

  return (
    <div className="mt-8">
      {/* Section header */}
      <h2 className="text-xl font-semibold mb-4">Advanced Analysis</h2>

      {/* Tab navigation */}
      <div className="border-b mb-6">
        <nav className="flex gap-4" aria-label="Analysis tabs">
          {enabledTabs.map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`pb-3 px-1 text-sm font-medium border-b-2 transition-colors ${
                activeTab === tab.id
                  ? 'border-primary text-primary'
                  : 'border-transparent text-muted-foreground hover:text-foreground hover:border-muted'
              }`}
            >
              {tab.label}
            </button>
          ))}
        </nav>
      </div>

      {/* Tab content */}
      <div className="min-h-[400px]">
        {/* Breakeven Tab */}
        {activeTab === 'breakeven' && analysis?.breakeven && (
          <BreakevenChart data={chartData} analysis={analysis.breakeven} />
        )}

        {/* Sensitivity Tab */}
        {activeTab === 'sensitivity' && analysis?.sensitivity && (
          <SensitivityChart result={analysis.sensitivity} />
        )}

        {/* Widow's Penalty Tab */}
        {activeTab === 'widow' && analysis?.widow && (
          <WidowAnalysis analysis={analysis.widow} />
        )}

        {/* Audit Log Tab */}
        {activeTab === 'audit' && (
          <AuditPanel clientId={client.id} />
        )}

        {/* Fallback for disabled/missing data */}
        {activeTab === 'sensitivity' && !analysis?.sensitivity && (
          <div className="text-center py-12 text-muted-foreground">
            <p>Sensitivity analysis not enabled for this client.</p>
            <p className="text-sm mt-2">
              Enable &quot;Run sensitivity analysis&quot; in Advanced Options to see scenario comparisons.
            </p>
          </div>
        )}

        {activeTab === 'widow' && !analysis?.widow && (
          <div className="text-center py-12 text-muted-foreground">
            <p>Widow&apos;s penalty analysis not available.</p>
            <p className="text-sm mt-2">
              This analysis is only available for Married Filing Jointly clients
              with &quot;Widow analysis&quot; enabled.
            </p>
          </div>
        )}
      </div>
    </div>
  );
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm both files compile.
Verify useAnalysis hook is exported from lib/queries/analysis.ts.
Verify AdvancedFeaturesSection is exported from component file.
  </verify>
  <done>
Analysis query hook fetches from /api/clients/[id]/analysis. AdvancedFeaturesSection provides tabbed interface for all advanced features with graceful fallbacks.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete advanced features integration:
- Analysis API endpoint (/api/clients/[id]/analysis)
- TanStack Query hook (useAnalysis)
- AdvancedFeaturesSection container with tabs
- All visualization components (BreakevenChart, SensitivityChart, WidowAnalysis, AuditPanel)
  </what-built>
  <how-to-verify>
1. Push changes to GitHub to trigger Vercel deploy
2. Navigate to https://rothc-lime.vercel.app
3. Log in and select an existing client
4. Navigate to Results page
5. Verify "Advanced Analysis" section appears below existing results
6. Click each tab and verify:
   - Breakeven Analysis: Chart with crossover markers, summary stats
   - Sensitivity (if enabled): 7-line fan chart with scenario comparison
   - Widow's Penalty (if MFJ and enabled): Bracket comparison table
   - Audit Log: List of past calculations (may be empty initially)
7. Run a new projection and verify audit log updates
8. Check console for any errors
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. API endpoint at /api/clients/[id]/analysis returns JSON
3. useAnalysis hook fetches and caches analysis data
4. AdvancedFeaturesSection renders tabs based on client settings
5. Charts render correctly with real data
6. Audit log populates after running calculations
7. No console errors in browser
</verification>

<success_criteria>
- API endpoint returns breakeven, sensitivity, widow analysis based on client flags
- Analysis is logged to audit table on every API call
- Query hook caches analysis for 5 minutes
- Tab navigation works correctly
- Disabled features show helpful message instead of empty state
- All charts match design specifications from earlier plans
- Audit panel shows history after calculations are run
</success_criteria>

<output>
After completion, create `.planning/phases/08-advanced-features/08-07-SUMMARY.md`
</output>
