---
phase: 03-client-data-entry-form
plan: 03
type: execute
wave: 2
depends_on: [03-01, 03-02]
files_modified:
  - components/clients/sections/personal-info.tsx
  - components/clients/sections/account-balances.tsx
  - components/clients/sections/tax-config.tsx
autonomous: true

must_haves:
  truths:
    - "PersonalInfo shows spouse DOB field only when filing status includes married"
    - "AccountBalances uses CurrencyInput for all 4 account fields"
    - "TaxConfig shows state dropdown with all 50 states + DC"
    - "TaxConfig auto-fills state tax rate when state changes"
  artifacts:
    - path: "components/clients/sections/personal-info.tsx"
      provides: "Personal info form section (6 fields)"
      exports: ["PersonalInfoSection"]
    - path: "components/clients/sections/account-balances.tsx"
      provides: "Account balances form section (4 fields)"
      exports: ["AccountBalancesSection"]
    - path: "components/clients/sections/tax-config.tsx"
      provides: "Tax configuration form section (4 fields)"
      exports: ["TaxConfigSection"]
  key_links:
    - from: "components/clients/sections/personal-info.tsx"
      to: "react-hook-form"
      via: "useFormContext"
      pattern: "useFormContext.*ClientFullFormData"
    - from: "components/clients/sections/account-balances.tsx"
      to: "components/ui/currency-input.tsx"
      via: "Controller + CurrencyInput"
      pattern: "Controller.*CurrencyInput"
    - from: "components/clients/sections/tax-config.tsx"
      to: "lib/data/states.ts"
      via: "US_STATES import"
      pattern: "import.*US_STATES.*states"
---

<objective>
Create the first three form sections: Personal Information, Account Balances, and Tax Configuration.

Purpose: Build the first half of the 28-field form covering client identity, account values, and tax settings.

Output: Three form section components that integrate with React Hook Form via useFormContext.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03-client-data-entry-form/03-RESEARCH.md
@.planning/phases/03-client-data-entry-form/03-01-SUMMARY.md
@.planning/phases/03-client-data-entry-form/03-02-SUMMARY.md
@components/clients/form-section.tsx
@components/ui/currency-input.tsx
@lib/validations/client.ts
@lib/data/states.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PersonalInfoSection component</name>
  <files>
    - components/clients/sections/personal-info.tsx
  </files>
  <action>
Create `components/clients/sections/personal-info.tsx`:

```typescript
"use client";

import { useEffect } from "react";
import { Controller, useFormContext } from "react-hook-form";
import type { ClientFullFormData } from "@/lib/validations/client";
import { FormSection } from "@/components/clients/form-section";
import { Field, FieldLabel, FieldError } from "@/components/ui/field";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { US_STATES } from "@/lib/data/states";
```

Component structure:
1. Use `useFormContext<ClientFullFormData>()` to access form
2. Watch filing_status to conditionally show spouse_dob:
   ```typescript
   const filingStatus = form.watch("filing_status");
   const isMarried = filingStatus?.includes("married");
   ```
3. Clear spouse_dob when user switches to non-married status:
   ```typescript
   useEffect(() => {
     if (!filingStatus?.includes("married")) {
       form.setValue("spouse_dob", null);
     }
   }, [filingStatus, form]);
   ```

Fields to render (all inside FormSection with title="Personal Information"):
1. **Client Name** - text Input with register("name")
2. **Date of Birth** - date Input with register("date_of_birth")
3. **State of Residence** - Select with US_STATES.map(), use Controller
4. **Filing Status** - Select with 4 options, use Controller
5. **Spouse DOB** - date Input, ONLY show if isMarried, use register("spouse_dob")
6. **Life Expectancy** - number Input, optional, use register("life_expectancy", { valueAsNumber: true })

Use Field, FieldLabel, FieldError from shadcn field.tsx for consistent styling.
Use `data-invalid={fieldState.invalid}` on Field for error styling.

Export as `PersonalInfoSection`.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Component exports correctly
  </verify>
  <done>
    - PersonalInfoSection renders 6 fields
    - Spouse DOB only appears when married status selected
    - State dropdown shows all 50 states + DC
    - Form errors display correctly with FieldError
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AccountBalancesSection component</name>
  <files>
    - components/clients/sections/account-balances.tsx
  </files>
  <action>
Create `components/clients/sections/account-balances.tsx`:

```typescript
"use client";

import { Controller, useFormContext } from "react-hook-form";
import type { ClientFullFormData } from "@/lib/validations/client";
import { FormSection } from "@/components/clients/form-section";
import { Field, FieldLabel, FieldError, FieldDescription } from "@/components/ui/field";
import { CurrencyInput } from "@/components/ui/currency-input";
```

Fields (all use Controller + CurrencyInput since CurrencyInput is custom):

1. **Traditional IRA** - Required, description: "Pre-tax retirement accounts"
2. **Roth IRA** - Optional (default 0), description: "Tax-free retirement accounts"
3. **Taxable Accounts** - Optional (default 0), description: "Brokerage, savings"
4. **Other Retirement** - Optional (default 0), description: "401k, 403b, etc."

Controller pattern for each:
```tsx
<Controller
  name="traditional_ira"
  control={form.control}
  render={({ field: { ref, ...field }, fieldState }) => (
    <Field data-invalid={fieldState.invalid}>
      <FieldLabel htmlFor="traditional_ira">Traditional IRA</FieldLabel>
      <CurrencyInput
        {...field}
        aria-invalid={fieldState.invalid}
      />
      <FieldDescription>Pre-tax retirement accounts</FieldDescription>
      <FieldError errors={[fieldState.error]} />
    </Field>
  )}
/>
```

Note: Extract `ref` from field but don't pass it (CurrencyInput doesn't forward refs to the underlying input in a way RHF expects). The pattern `{ ref, ...field }` discards ref safely.

FormSection title: "Account Balances"
FormSection description: "Current balances in today's dollars"

Export as `AccountBalancesSection`.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - CurrencyInput displays dollar formatting
  </verify>
  <done>
    - AccountBalancesSection renders 4 currency fields
    - All fields use CurrencyInput with $ prefix
    - Values stored as cents internally
    - Error states display correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Create TaxConfigSection component</name>
  <files>
    - components/clients/sections/tax-config.tsx
  </files>
  <action>
Create `components/clients/sections/tax-config.tsx`:

```typescript
"use client";

import { useEffect } from "react";
import { Controller, useFormContext } from "react-hook-form";
import type { ClientFullFormData } from "@/lib/validations/client";
import { FormSection } from "@/components/clients/form-section";
import { Field, FieldLabel, FieldError, FieldDescription } from "@/components/ui/field";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { PercentInput } from "@/components/ui/percent-input";
import { Checkbox } from "@/components/ui/checkbox"; // May need to add this
import { FEDERAL_BRACKETS } from "@/lib/data/federal-brackets";
import { getDefaultStateTaxRate } from "@/lib/data/states";
```

Smart default behavior:
```typescript
const state = form.watch("state");

// Auto-update state tax rate when state changes
useEffect(() => {
  if (state && state.length === 2) {
    const defaultRate = getDefaultStateTaxRate(state);
    form.setValue("state_tax_rate", defaultRate);
  }
}, [state, form]);
```

Fields:

1. **Federal Bracket** - Select with FEDERAL_BRACKETS, use Controller
2. **State Tax Rate** - PercentInput, auto-filled from state selection, use Controller
3. **Include NIIT** - Checkbox, default true
4. **Include ACA** - Checkbox, default false, description: "For pre-Medicare clients"

For checkboxes with React Hook Form:
```tsx
<Controller
  name="include_niit"
  control={form.control}
  render={({ field }) => (
    <Field orientation="horizontal">
      <Checkbox
        id="include_niit"
        checked={field.value}
        onCheckedChange={field.onChange}
      />
      <FieldLabel htmlFor="include_niit">Include NIIT (3.8% surtax)</FieldLabel>
    </Field>
  )}
/>
```

FormSection title: "Tax Configuration"

Export as `TaxConfigSection`.

Note: If Checkbox component doesn't exist, create a simple one or use the native checkbox with proper styling.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - State tax rate updates when state changes
  </verify>
  <done>
    - TaxConfigSection renders 4 fields
    - Federal bracket shows all 8 options including auto
    - State tax rate auto-updates based on state selection
    - Checkboxes work with proper boolean values
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. All sections render within FormProvider context
3. Conditional logic (spouse DOB, state tax rate) works correctly
</verification>

<success_criteria>
- PersonalInfoSection conditionally shows spouse DOB
- AccountBalancesSection uses CurrencyInput for all currency fields
- TaxConfigSection auto-fills state tax rate from state selection
- All sections use FormSection wrapper for consistent layout
- All sections use useFormContext (no prop drilling)
</success_criteria>

<output>
After completion, create `.planning/phases/03-client-data-entry-form/03-03-SUMMARY.md`
</output>
