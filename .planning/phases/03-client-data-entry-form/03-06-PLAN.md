---
phase: 03-client-data-entry-form
plan: 06
type: execute
wave: 3
depends_on: [03-02]
files_modified:
  - supabase/migrations/YYYYMMDDHHMMSS_add_client_fields.sql
  - app/api/clients/route.ts
  - app/api/clients/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "Database schema has all 28 client fields"
    - "Existing clients are not broken by migration (defaults applied)"
    - "API routes handle new fields correctly"
  artifacts:
    - path: "supabase/migrations/YYYYMMDDHHMMSS_add_client_fields.sql"
      provides: "Migration adding 24 new columns to clients table"
      contains: "ALTER TABLE clients ADD COLUMN"
  key_links:
    - from: "app/api/clients/route.ts"
      to: "lib/types/client.ts"
      via: "ClientInsert type"
      pattern: "ClientInsert"
---

<objective>
Add database migration for new client fields and update API routes to handle full schema.

Purpose: Extend the clients table from 4 fields to 28 fields with appropriate defaults so existing records remain valid.

Output: Database migration file and updated API routes ready for the full form.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03-client-data-entry-form/03-RESEARCH.md
@.planning/phases/03-client-data-entry-form/03-02-SUMMARY.md
@lib/types/client.ts
@app/api/clients/route.ts
@app/api/clients/[id]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for new client fields</name>
  <files>
    - supabase/migrations/YYYYMMDDHHMMSS_add_client_fields.sql
  </files>
  <action>
Create a new migration file in `supabase/migrations/` with timestamp format (e.g., `20260118120000_add_client_fields.sql`).

The migration should add 24 new columns to the clients table. Current schema has:
- id, user_id, name, date_of_birth, state, filing_status, created_at, updated_at

New columns to add (with defaults so existing rows don't break):

```sql
-- Add remaining 24 fields to clients table
-- Phase 03: Client Data Entry Form

-- Personal Information (1 new field, others already exist)
ALTER TABLE clients ADD COLUMN IF NOT EXISTS spouse_dob DATE;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS life_expectancy INTEGER;

-- Account Balances (4 fields) - stored as cents (BIGINT for large amounts)
ALTER TABLE clients ADD COLUMN IF NOT EXISTS traditional_ira BIGINT NOT NULL DEFAULT 0;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS roth_ira BIGINT NOT NULL DEFAULT 0;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS taxable_accounts BIGINT NOT NULL DEFAULT 0;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS other_retirement BIGINT NOT NULL DEFAULT 0;

-- Tax Configuration (4 fields)
ALTER TABLE clients ADD COLUMN IF NOT EXISTS federal_bracket TEXT NOT NULL DEFAULT 'auto';
ALTER TABLE clients ADD COLUMN IF NOT EXISTS state_tax_rate NUMERIC(5,2);
ALTER TABLE clients ADD COLUMN IF NOT EXISTS include_niit BOOLEAN NOT NULL DEFAULT true;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS include_aca BOOLEAN NOT NULL DEFAULT false;

-- Income Sources (5 fields) - stored as cents
ALTER TABLE clients ADD COLUMN IF NOT EXISTS ss_self BIGINT NOT NULL DEFAULT 0;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS ss_spouse BIGINT NOT NULL DEFAULT 0;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS pension BIGINT NOT NULL DEFAULT 0;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS other_income BIGINT NOT NULL DEFAULT 0;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS ss_start_age INTEGER NOT NULL DEFAULT 67;

-- Conversion Settings (4 fields)
ALTER TABLE clients ADD COLUMN IF NOT EXISTS strategy TEXT NOT NULL DEFAULT 'moderate';
ALTER TABLE clients ADD COLUMN IF NOT EXISTS start_age INTEGER NOT NULL DEFAULT 65;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS end_age INTEGER NOT NULL DEFAULT 75;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS tax_payment_source TEXT NOT NULL DEFAULT 'from_taxable';

-- Advanced Options (5 fields)
ALTER TABLE clients ADD COLUMN IF NOT EXISTS growth_rate NUMERIC(5,2) NOT NULL DEFAULT 6.0;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS inflation_rate NUMERIC(5,2) NOT NULL DEFAULT 2.5;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS heir_bracket TEXT NOT NULL DEFAULT '32';
ALTER TABLE clients ADD COLUMN IF NOT EXISTS projection_years INTEGER NOT NULL DEFAULT 40;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS widow_analysis BOOLEAN NOT NULL DEFAULT false;

-- Add check constraints for enum-like fields
ALTER TABLE clients ADD CONSTRAINT check_strategy
  CHECK (strategy IN ('conservative', 'moderate', 'aggressive', 'irmaa_safe'));
ALTER TABLE clients ADD CONSTRAINT check_tax_payment_source
  CHECK (tax_payment_source IN ('from_ira', 'from_taxable'));

-- Add comments for documentation
COMMENT ON COLUMN clients.traditional_ira IS 'Traditional IRA balance in cents';
COMMENT ON COLUMN clients.roth_ira IS 'Roth IRA balance in cents';
COMMENT ON COLUMN clients.taxable_accounts IS 'Taxable account balance in cents';
COMMENT ON COLUMN clients.other_retirement IS 'Other retirement accounts in cents';
COMMENT ON COLUMN clients.ss_self IS 'Annual Social Security benefit (self) in cents';
COMMENT ON COLUMN clients.ss_spouse IS 'Annual Social Security benefit (spouse) in cents';
COMMENT ON COLUMN clients.pension IS 'Annual pension income in cents';
COMMENT ON COLUMN clients.other_income IS 'Other annual income in cents';
COMMENT ON COLUMN clients.strategy IS 'Conversion strategy: conservative, moderate, aggressive, irmaa_safe';
COMMENT ON COLUMN clients.tax_payment_source IS 'Source for conversion tax: from_ira or from_taxable';
```

Use timestamp for filename based on current time.
  </action>
  <verify>
    - Migration file exists in supabase/migrations/
    - SQL syntax is valid (no syntax errors)
  </verify>
  <done>
    - Migration adds all 24 new columns
    - All columns have sensible defaults
    - Existing rows will have default values applied
    - Check constraints ensure data integrity
  </done>
</task>

<task type="auto">
  <name>Task 2: Update API routes for full schema</name>
  <files>
    - app/api/clients/route.ts
    - app/api/clients/[id]/route.ts
  </files>
  <action>
The API routes should already work with the expanded types since they use:
- `ClientInsert` for POST body (now includes all 28 fields)
- `ClientUpdate` for PUT body (now includes all 28 fields as optional)

However, verify and update if needed:

1. Check `app/api/clients/route.ts` POST handler:
   - Should accept `ClientInsert` which now has all fields
   - Supabase insert should work with any subset of fields (defaults handle rest)

2. Check `app/api/clients/[id]/route.ts` PUT handler:
   - Should accept `ClientUpdate` which is `Partial<ClientInsert>`
   - Only provided fields should update

If the routes use strict Zod validation on request bodies, they may need updating to use `clientFullSchema` instead of `clientCreateSchema`. Check and update as needed.

Specific changes likely needed:

In `app/api/clients/route.ts`:
```typescript
// Change from
import { clientCreateSchema } from "@/lib/validations/client";

// To
import { clientFullSchema } from "@/lib/validations/client";

// And in POST handler:
const parsed = clientFullSchema.safeParse(body);
```

In `app/api/clients/[id]/route.ts`:
```typescript
// For PUT, use partial schema
import { clientFullSchema } from "@/lib/validations/client";

// Validate with partial
const parsed = clientFullSchema.partial().safeParse(body);
```

Alternatively, if the routes trust the client-side validation and just type-cast, they may work without changes. Verify by reading the current implementation.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - API routes compile without type errors
  </verify>
  <done>
    - POST /api/clients accepts all 28 fields
    - PUT /api/clients/[id] accepts partial updates of any field
    - Routes use correct schema for validation
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. Migration file is syntactically valid SQL
3. API routes accept the full form data
</verification>

<success_criteria>
- Database migration ready to add 24 new columns
- All columns have appropriate defaults for existing data
- Check constraints validate enum fields
- API routes handle full 28-field schema
- No breaking changes to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/03-client-data-entry-form/03-06-SUMMARY.md`
</output>
