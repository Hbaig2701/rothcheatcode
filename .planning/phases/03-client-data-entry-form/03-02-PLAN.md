---
phase: 03-client-data-entry-form
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/validations/client.ts
  - lib/types/client.ts
autonomous: true

must_haves:
  truths:
    - "Zod schema validates all 28 fields with appropriate types"
    - "Spouse DOB is required when filing status includes married"
    - "End age must be greater than start age"
    - "Currency fields validate as non-negative integers (cents)"
  artifacts:
    - path: "lib/validations/client.ts"
      provides: "Complete 28-field validation schema"
      exports: ["clientFullSchema", "ClientFullFormData", "filingStatusEnum", "strategyEnum", "taxSourceEnum"]
    - path: "lib/types/client.ts"
      provides: "Updated Client interface with all 28 fields"
      exports: ["Client", "ClientInsert", "ClientUpdate"]
  key_links:
    - from: "lib/validations/client.ts"
      to: "lib/types/client.ts"
      via: "Type inference alignment"
      pattern: "ClientFullFormData.*infer"
---

<objective>
Expand Zod validation schema and TypeScript types to support all 28 client data entry fields.

Purpose: Define the complete data contract for client records including personal info, accounts, tax config, income, conversion settings, and advanced options.

Output: Comprehensive Zod schema with conditional validation and updated Client type matching database columns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-client-data-entry-form/03-RESEARCH.md
@.planning/REQUIREMENTS.md
@lib/validations/client.ts
@lib/types/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand Zod validation schema to 28 fields</name>
  <files>
    - lib/validations/client.ts
  </files>
  <action>
Update `lib/validations/client.ts` to add the full 28-field schema while preserving existing clientCreateSchema and clientUpdateSchema:

1. Add enum schemas at the top:
   ```typescript
   export const filingStatusEnum = z.enum([
     "single",
     "married_filing_jointly",
     "married_filing_separately",
     "head_of_household"
   ]);

   export const strategyEnum = z.enum([
     "conservative",
     "moderate",
     "aggressive",
     "irmaa_safe"
   ]);

   export const taxSourceEnum = z.enum(["from_ira", "from_taxable"]);
   ```

2. Create `clientFullSchema` with all 28 fields organized in sections:

   **Personal Information (6 fields):**
   - name: z.string().min(1, "Name is required").max(100)
   - date_of_birth: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, "Use YYYY-MM-DD format")
   - state: z.string().length(2, "Use 2-letter state code")
   - filing_status: filingStatusEnum
   - spouse_dob: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional().nullable()
   - life_expectancy: z.number().int().min(1).max(120).optional().nullable()

   **Account Balances (4 fields) - stored as cents (integers):**
   - traditional_ira: z.number().int().min(0, "Amount must be positive")
   - roth_ira: z.number().int().min(0).default(0)
   - taxable_accounts: z.number().int().min(0).default(0)
   - other_retirement: z.number().int().min(0).default(0)

   **Tax Configuration (4 fields):**
   - federal_bracket: z.string().default("auto")
   - state_tax_rate: z.number().min(0).max(100).optional().nullable()
   - include_niit: z.boolean().default(true)
   - include_aca: z.boolean().default(false)

   **Income Sources (5 fields) - stored as cents:**
   - ss_self: z.number().int().min(0).default(0)
   - ss_spouse: z.number().int().min(0).default(0)
   - pension: z.number().int().min(0).default(0)
   - other_income: z.number().int().min(0).default(0)
   - ss_start_age: z.number().int().min(62).max(70).default(67)

   **Conversion Settings (4 fields):**
   - strategy: strategyEnum.default("moderate")
   - start_age: z.number().int().min(50).max(90)
   - end_age: z.number().int().min(55).max(95).default(75)
   - tax_payment_source: taxSourceEnum.default("from_taxable")

   **Advanced Options (5 fields):**
   - growth_rate: z.number().min(0).max(20).default(6)
   - inflation_rate: z.number().min(0).max(10).default(2.5)
   - heir_bracket: z.string().default("32")
   - projection_years: z.number().int().min(10).max(60).default(40)
   - widow_analysis: z.boolean().default(false)

3. Add `.superRefine()` for conditional validation:
   - If filing_status includes "married" and spouse_dob is missing, add issue
   - If end_age <= start_age, add issue on end_age

4. Export type:
   ```typescript
   export type ClientFullFormData = z.infer<typeof clientFullSchema>;
   ```

5. Keep existing clientCreateSchema and clientUpdateSchema unchanged (for backwards compatibility).

Important Zod v4 notes:
- Use `{ error: "message" }` syntax NOT `{ message: "message" }`
- The project uses Zod v4.3.5
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Schema parses valid data correctly
    - Schema rejects invalid data with appropriate errors
  </verify>
  <done>
    - clientFullSchema exports with all 28 fields
    - filingStatusEnum, strategyEnum, taxSourceEnum exported
    - ClientFullFormData type inferred from schema
    - Conditional validation works for spouse_dob and end_age
    - Existing schemas preserved for backwards compatibility
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Client types with all 28 fields</name>
  <files>
    - lib/types/client.ts
  </files>
  <action>
Update `lib/types/client.ts` to add all 28 fields to the Client interface:

```typescript
// Client type matching Supabase schema (all 28 fields)
export interface Client {
  // System fields
  id: string;
  user_id: string;
  created_at: string;
  updated_at: string;

  // Personal Information (6 fields)
  name: string;
  date_of_birth: string; // ISO date string YYYY-MM-DD
  state: string; // 2-letter state code
  filing_status: "single" | "married_filing_jointly" | "married_filing_separately" | "head_of_household";
  spouse_dob: string | null;
  life_expectancy: number | null;

  // Account Balances (4 fields) - stored as cents
  traditional_ira: number;
  roth_ira: number;
  taxable_accounts: number;
  other_retirement: number;

  // Tax Configuration (4 fields)
  federal_bracket: string;
  state_tax_rate: number | null;
  include_niit: boolean;
  include_aca: boolean;

  // Income Sources (5 fields) - stored as cents
  ss_self: number;
  ss_spouse: number;
  pension: number;
  other_income: number;
  ss_start_age: number;

  // Conversion Settings (4 fields)
  strategy: "conservative" | "moderate" | "aggressive" | "irmaa_safe";
  start_age: number;
  end_age: number;
  tax_payment_source: "from_ira" | "from_taxable";

  // Advanced Options (5 fields)
  growth_rate: number;
  inflation_rate: number;
  heir_bracket: string;
  projection_years: number;
  widow_analysis: boolean;
}

// For creating a new client - omit system fields, all 28 required/optional as schema defines
export type ClientInsert = Omit<Client, "id" | "user_id" | "created_at" | "updated_at">;

// For updating a client - all fields optional
export type ClientUpdate = Partial<ClientInsert>;
```

Note: The ClientInsert type will now include all 28 fields. Fields with schema defaults will still need values at insert time unless database has defaults too.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - ClientInsert has all 28 data fields
    - ClientUpdate is partial of ClientInsert
  </verify>
  <done>
    - Client interface has all 28 fields plus system fields
    - Fields match Zod schema types exactly
    - Currency fields are numbers (cents)
    - Nullable fields properly typed
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. Types and schema align (no type mismatches)
3. Schema validates correctly with test data
</verification>

<success_criteria>
- clientFullSchema validates all 28 fields
- Conditional validation for spouse_dob and end_age works
- Client type matches schema structure
- Existing schemas (clientCreateSchema, clientUpdateSchema) unchanged
- Ready for form sections to use schema and types
</success_criteria>

<output>
After completion, create `.planning/phases/03-client-data-entry-form/03-02-SUMMARY.md`
</output>
