---
phase: 03-client-data-entry-form
plan: 05
type: execute
wave: 3
depends_on: [03-02, 03-03, 03-04]
files_modified:
  - components/clients/client-form.tsx
  - hooks/use-smart-defaults.ts
autonomous: true

must_haves:
  truths:
    - "ClientForm renders all 6 form sections in order"
    - "Smart defaults auto-calculate life expectancy from DOB"
    - "Smart defaults auto-calculate start age from current age"
    - "Form submits successfully and calls mutation hooks"
  artifacts:
    - path: "components/clients/client-form.tsx"
      provides: "Complete 28-field client form"
      exports: ["ClientForm"]
    - path: "hooks/use-smart-defaults.ts"
      provides: "Smart defaults hook for auto-calculations"
      exports: ["useSmartDefaults"]
  key_links:
    - from: "components/clients/client-form.tsx"
      to: "react-hook-form"
      via: "FormProvider wrapper"
      pattern: "FormProvider.*form"
    - from: "components/clients/client-form.tsx"
      to: "components/clients/sections/*"
      via: "Section component imports"
      pattern: "PersonalInfoSection.*AccountBalancesSection"
    - from: "hooks/use-smart-defaults.ts"
      to: "react-hook-form"
      via: "UseFormReturn type"
      pattern: "UseFormReturn.*ClientFullFormData"
---

<objective>
Update ClientForm to compose all 6 sections and add smart defaults hook for auto-calculations.

Purpose: Create the complete 28-field form with intelligent defaults for life expectancy and start age based on user input.

Output: Fully functional ClientForm component with FormProvider context and smart defaults.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03-client-data-entry-form/03-RESEARCH.md
@.planning/phases/03-client-data-entry-form/03-02-SUMMARY.md
@.planning/phases/03-client-data-entry-form/03-03-SUMMARY.md
@.planning/phases/03-client-data-entry-form/03-04-SUMMARY.md
@components/clients/client-form.tsx
@lib/validations/client.ts
@lib/queries/clients.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSmartDefaults hook</name>
  <files>
    - hooks/use-smart-defaults.ts
  </files>
  <action>
Create `hooks/use-smart-defaults.ts`:

```typescript
"use client";

import { useEffect } from "react";
import { UseFormReturn } from "react-hook-form";
import type { ClientFullFormData } from "@/lib/validations/client";

/**
 * Calculate life expectancy based on DOB using simplified actuarial estimate.
 * Returns age at expected death (current age + remaining years).
 * Uses SSA period life table approximation.
 */
function calculateLifeExpectancy(dob: string): number | null {
  try {
    const birthDate = new Date(dob);
    const today = new Date();
    const currentAge = today.getFullYear() - birthDate.getFullYear();

    if (currentAge < 0 || currentAge > 120) return null;

    // Simplified actuarial approximation based on SSA tables
    // Average remaining years decreases with age
    let remainingYears: number;
    if (currentAge < 65) {
      remainingYears = 85 - currentAge; // Rough estimate: expect to live to 85
    } else if (currentAge < 75) {
      remainingYears = 90 - currentAge; // Older folks: expect to live to 90
    } else {
      remainingYears = Math.max(5, 95 - currentAge); // Very old: at least 5 more years
    }

    return currentAge + remainingYears;
  } catch {
    return null;
  }
}

/**
 * Calculate current age from DOB
 */
function calculateCurrentAge(dob: string): number | null {
  try {
    const birthDate = new Date(dob);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    return age >= 0 && age <= 120 ? age : null;
  } catch {
    return null;
  }
}

export function useSmartDefaults(form: UseFormReturn<ClientFullFormData>) {
  const dob = form.watch("date_of_birth");

  // Calculate default life expectancy from DOB
  useEffect(() => {
    if (dob && dob.match(/^\d{4}-\d{2}-\d{2}$/)) {
      const currentLifeExp = form.getValues("life_expectancy");
      // Only set if not already set (don't override user input)
      if (currentLifeExp === null || currentLifeExp === undefined) {
        const lifeExp = calculateLifeExpectancy(dob);
        if (lifeExp) {
          form.setValue("life_expectancy", lifeExp);
        }
      }
    }
  }, [dob, form]);

  // Calculate default start age from current age
  useEffect(() => {
    if (dob && dob.match(/^\d{4}-\d{2}-\d{2}$/)) {
      const currentStartAge = form.getValues("start_age");
      // Only set if it's the initial default or hasn't been touched
      if (currentStartAge === undefined || currentStartAge === 65) {
        const age = calculateCurrentAge(dob);
        if (age !== null) {
          // Start conversion at current age or minimum 50
          form.setValue("start_age", Math.max(age, 50));
        }
      }
    }
  }, [dob, form]);
}
```

Export the hook as `useSmartDefaults`.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Hook exports correctly
  </verify>
  <done>
    - useSmartDefaults calculates life expectancy from DOB
    - useSmartDefaults calculates start age from current age
    - Only sets values if not already user-modified
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ClientForm to use all sections and full schema</name>
  <files>
    - components/clients/client-form.tsx
  </files>
  <action>
Rewrite `components/clients/client-form.tsx` to use the full 28-field form:

```typescript
"use client";

import { useForm, FormProvider } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { useRouter } from "next/navigation";
import { clientFullSchema, type ClientFullFormData } from "@/lib/validations/client";
import { useCreateClient, useUpdateClient } from "@/lib/queries/clients";
import { useSmartDefaults } from "@/hooks/use-smart-defaults";
import type { Client } from "@/lib/types/client";

import { Button } from "@/components/ui/button";
import { Card, CardContent, CardFooter, CardHeader, CardTitle } from "@/components/ui/card";
import { Loader2 } from "lucide-react";

// Import all 6 sections
import { PersonalInfoSection } from "./sections/personal-info";
import { AccountBalancesSection } from "./sections/account-balances";
import { TaxConfigSection } from "./sections/tax-config";
import { IncomeSourcesSection } from "./sections/income-sources";
import { ConversionSection } from "./sections/conversion";
import { AdvancedSection } from "./sections/advanced";

interface ClientFormProps {
  client?: Client; // If provided, form is in edit mode
  onCancel?: () => void;
}

export function ClientForm({ client, onCancel }: ClientFormProps) {
  const router = useRouter();
  const isEditing = !!client;

  const createClient = useCreateClient();
  const updateClient = useUpdateClient();

  const form = useForm<ClientFullFormData>({
    resolver: zodResolver(clientFullSchema),
    defaultValues: {
      // Personal (use client values if editing)
      name: client?.name ?? "",
      date_of_birth: client?.date_of_birth ?? "",
      state: client?.state ?? "",
      filing_status: client?.filing_status ?? "married_filing_jointly",
      spouse_dob: client?.spouse_dob ?? null,
      life_expectancy: client?.life_expectancy ?? null,

      // Account Balances (in cents)
      traditional_ira: client?.traditional_ira ?? 0,
      roth_ira: client?.roth_ira ?? 0,
      taxable_accounts: client?.taxable_accounts ?? 0,
      other_retirement: client?.other_retirement ?? 0,

      // Tax Configuration
      federal_bracket: client?.federal_bracket ?? "auto",
      state_tax_rate: client?.state_tax_rate ?? null,
      include_niit: client?.include_niit ?? true,
      include_aca: client?.include_aca ?? false,

      // Income Sources (in cents)
      ss_self: client?.ss_self ?? 0,
      ss_spouse: client?.ss_spouse ?? 0,
      pension: client?.pension ?? 0,
      other_income: client?.other_income ?? 0,
      ss_start_age: client?.ss_start_age ?? 67,

      // Conversion Settings
      strategy: client?.strategy ?? "moderate",
      start_age: client?.start_age ?? 65,
      end_age: client?.end_age ?? 75,
      tax_payment_source: client?.tax_payment_source ?? "from_taxable",

      // Advanced Options
      growth_rate: client?.growth_rate ?? 6,
      inflation_rate: client?.inflation_rate ?? 2.5,
      heir_bracket: client?.heir_bracket ?? "32",
      projection_years: client?.projection_years ?? 40,
      widow_analysis: client?.widow_analysis ?? false,
    },
  });

  // Apply smart defaults (life expectancy, start age from DOB)
  useSmartDefaults(form);

  const isPending = createClient.isPending || updateClient.isPending;

  const onSubmit = async (data: ClientFullFormData) => {
    try {
      if (isEditing && client) {
        await updateClient.mutateAsync({ id: client.id, data });
        router.push(`/clients/${client.id}`);
      } else {
        await createClient.mutateAsync(data);
        router.push("/clients");
      }
    } catch (error) {
      // Error is displayed via mutation state
      console.error("Form submission error:", error);
    }
  };

  const handleCancel = () => {
    if (onCancel) {
      onCancel();
    } else if (isEditing && client) {
      router.push(`/clients/${client.id}`);
    } else {
      router.push("/clients");
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>{isEditing ? "Edit Client" : "New Client"}</CardTitle>
      </CardHeader>
      <FormProvider {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)}>
          <CardContent className="space-y-8">
            <PersonalInfoSection />
            <AccountBalancesSection />
            <TaxConfigSection />
            <IncomeSourcesSection />
            <ConversionSection />
            <AdvancedSection />

            {/* API error display */}
            {(createClient.isError || updateClient.isError) && (
              <div className="rounded-md bg-red-50 p-3 text-sm text-red-600">
                {createClient.error?.message || updateClient.error?.message}
              </div>
            )}
          </CardContent>

          <CardFooter className="flex justify-end gap-2">
            <Button type="button" variant="outline" onClick={handleCancel}>
              Cancel
            </Button>
            <Button type="submit" disabled={isPending}>
              {isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              {isEditing ? "Save Changes" : "Create Client"}
            </Button>
          </CardFooter>
        </form>
      </FormProvider>
    </Card>
  );
}
```

Key changes from original:
1. Use `clientFullSchema` instead of `clientCreateSchema`
2. Use `FormProvider` wrapper so sections can use `useFormContext`
3. Import and render all 6 section components
4. Default values for all 28 fields
5. Apply `useSmartDefaults` hook
6. Type is now `ClientFullFormData`
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Form renders all 6 sections
  </verify>
  <done>
    - ClientForm uses clientFullSchema with all 28 fields
    - FormProvider wraps form so sections can use useFormContext
    - All 6 sections render in order
    - Smart defaults hook applied
    - Edit mode populates from client prop
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. Navigate to /clients/new and verify form renders
3. All 6 sections visible with correct fields
4. Smart defaults trigger when DOB entered
</verification>

<success_criteria>
- ClientForm renders complete 28-field form
- FormProvider enables useFormContext in sections
- Smart defaults auto-fill life expectancy and start age
- Form validation works end-to-end
- Create and edit modes function correctly
</success_criteria>

<output>
After completion, create `.planning/phases/03-client-data-entry-form/03-05-SUMMARY.md`
</output>
