---
phase: 06-multi-strategy-comparison
plan: 03
type: execute
wave: 3
depends_on: [06-01, 06-02]
files_modified:
  - components/results/multi-strategy-results.tsx
  - app/(dashboard)/clients/[id]/results/page.tsx
  - lib/hooks/use-multi-strategy.ts
  - components/results/index.ts
autonomous: false

must_haves:
  truths:
    - "Results page runs multi-strategy simulation and displays comparison table"
    - "Clicking a strategy in the table switches the detail view"
    - "Detail view shows summary cards and wealth chart for selected strategy"
    - "Best strategy is pre-selected by default"
  artifacts:
    - path: "components/results/multi-strategy-results.tsx"
      provides: "Container component for multi-strategy comparison + detail view"
      min_lines: 80
    - path: "lib/hooks/use-multi-strategy.ts"
      provides: "React Query hook for multi-strategy calculation"
      exports: ["useMultiStrategy"]
    - path: "app/(dashboard)/clients/[id]/results/page.tsx"
      provides: "Updated results page using multi-strategy"
      contains: "MultiStrategyResults"
  key_links:
    - from: "components/results/multi-strategy-results.tsx"
      to: "components/results/strategy-comparison/index.ts"
      via: "import StrategyComparisonTable"
      pattern: "import.*StrategyComparisonTable"
    - from: "components/results/multi-strategy-results.tsx"
      to: "lib/hooks/use-multi-strategy.ts"
      via: "import useMultiStrategy"
      pattern: "import.*useMultiStrategy"
    - from: "app/(dashboard)/clients/[id]/results/page.tsx"
      to: "components/results/multi-strategy-results.tsx"
      via: "import MultiStrategyResults"
      pattern: "import.*MultiStrategyResults"
---

<objective>
Integrate multi-strategy comparison into the results page.

Purpose: Replace the single-strategy results view with a multi-strategy comparison that shows all 4 strategies side-by-side, with ability to drill down into any strategy's detail view.
Output: Updated results page at /clients/[id]/results showing comparison table above the existing summary cards and wealth chart.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-multi-strategy-comparison/06-RESEARCH.md
@.planning/phases/06-multi-strategy-comparison/06-01-SUMMARY.md
@.planning/phases/06-multi-strategy-comparison/06-02-SUMMARY.md

@lib/calculations/multi-strategy.ts
@lib/calculations/transforms.ts
@components/results/index.ts
@components/results/results-summary.tsx
@app/(dashboard)/clients/[id]/results/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useMultiStrategy hook</name>
  <files>lib/hooks/use-multi-strategy.ts</files>
  <action>
Create `lib/hooks/use-multi-strategy.ts`:

```typescript
import { useQuery } from '@tanstack/react-query';
import { MultiStrategyResult } from '@/lib/calculations/types';

interface UseMultiStrategyOptions {
  clientId: string;
  enabled?: boolean;
}

interface MultiStrategyResponse {
  result: MultiStrategyResult;
  cached: boolean;
}

/**
 * Fetch or calculate multi-strategy projection for a client
 *
 * This hook calls an API endpoint that runs runMultiStrategySimulation
 * server-side and returns all 4 strategy results.
 */
export function useMultiStrategy({ clientId, enabled = true }: UseMultiStrategyOptions) {
  return useQuery<MultiStrategyResponse>({
    queryKey: ['multi-strategy', clientId],
    queryFn: async () => {
      const response = await fetch(`/api/clients/${clientId}/multi-strategy`);

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.error || 'Failed to calculate multi-strategy projection');
      }

      return response.json();
    },
    enabled,
    staleTime: 5 * 60 * 1000, // 5 minutes
    gcTime: 10 * 60 * 1000,   // 10 minutes (renamed from cacheTime in React Query v5)
  });
}
```

Create the API endpoint `app/api/clients/[id]/multi-strategy/route.ts`:

```typescript
import { createClient } from '@/lib/supabase/server';
import { NextResponse } from 'next/server';
import { runMultiStrategySimulation } from '@/lib/calculations';
import { Client } from '@/lib/types/client';

interface RouteContext {
  params: Promise<{ id: string }>;
}

export async function GET(request: Request, context: RouteContext) {
  const { id } = await context.params;
  const supabase = await createClient();

  // Verify authentication
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // Fetch client data
  const { data: client, error: fetchError } = await supabase
    .from('clients')
    .select('*')
    .eq('id', id)
    .single();

  if (fetchError || !client) {
    const status = fetchError?.code === 'PGRST116' ? 404 : 500;
    return NextResponse.json(
      { error: status === 404 ? 'Client not found' : 'Failed to fetch client' },
      { status }
    );
  }

  // Run multi-strategy simulation
  const currentYear = new Date().getFullYear();
  const projectionYears = client.projection_years || 40;

  try {
    const result = runMultiStrategySimulation(
      client as Client,
      currentYear,
      currentYear + projectionYears
    );

    return NextResponse.json({
      result,
      cached: false // Could implement caching layer later
    });
  } catch (error) {
    console.error('Multi-strategy calculation error:', error);
    return NextResponse.json(
      { error: 'Failed to calculate projections' },
      { status: 500 }
    );
  }
}
```

Key implementation notes:
- Follows existing API route patterns (02-02-PLAN.md decisions)
- Uses getUser() not getSession() for secure JWT validation
- PGRST116 error code maps to 404
- Next.js 15 async params pattern
- Returns cached: false (caching enhancement for later)
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile.
Check hook exists: `ls lib/hooks/use-multi-strategy.ts`
Check API route exists: `ls app/api/clients/\[id\]/multi-strategy/route.ts`
  </verify>
  <done>
useMultiStrategy hook and API endpoint created. Fetches multi-strategy results for a client.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MultiStrategyResults container</name>
  <files>
    components/results/multi-strategy-results.tsx
    components/results/index.ts
  </files>
  <action>
Create `components/results/multi-strategy-results.tsx`:

```typescript
'use client';

import { useState } from 'react';
import { useMultiStrategy } from '@/lib/hooks/use-multi-strategy';
import { transformToChartData, extractSummaryMetrics } from '@/lib/calculations/transforms';
import { StrategyComparisonTable } from './strategy-comparison';
import { SummarySection } from './summary-section';
import { WealthChart } from './wealth-chart';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Skeleton } from '@/components/ui/skeleton';
import { AlertCircle, RefreshCw } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { StrategyType } from '@/lib/calculations/types';
import { STRATEGY_DEFINITIONS } from '@/lib/calculations/strategy-definitions';

interface MultiStrategyResultsProps {
  clientId: string;
  clientName: string;
}

export function MultiStrategyResults({ clientId, clientName }: MultiStrategyResultsProps) {
  const { data, isLoading, isError, error, refetch } = useMultiStrategy({ clientId });

  // Selected strategy for detail view - defaults to best when data loads
  const [selectedStrategy, setSelectedStrategy] = useState<StrategyType | null>(null);

  // Determine which strategy to show in detail view
  const activeStrategy = selectedStrategy ?? data?.result.bestStrategy ?? 'moderate';

  // Loading state
  if (isLoading) {
    return (
      <div className="space-y-6">
        <div>
          <h1 className="text-2xl font-bold">Results for {clientName}</h1>
          <p className="text-muted-foreground">Calculating all 4 strategies...</p>
        </div>
        {/* Comparison table skeleton */}
        <Skeleton className="h-[300px]" />
        {/* Summary cards skeleton */}
        <div className="grid gap-4 md:grid-cols-3">
          <Skeleton className="h-[120px]" />
          <Skeleton className="h-[120px]" />
          <Skeleton className="h-[120px]" />
        </div>
        {/* Chart skeleton */}
        <Skeleton className="h-[400px]" />
      </div>
    );
  }

  // Error state
  if (isError) {
    return (
      <div className="space-y-6">
        <div>
          <h1 className="text-2xl font-bold">Results for {clientName}</h1>
        </div>
        <Card className="border-destructive">
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-destructive">
              <AlertCircle className="h-5 w-5" />
              Error Loading Results
            </CardTitle>
            <CardDescription>
              {error instanceof Error ? error.message : 'Failed to calculate projections'}
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button onClick={() => refetch()} variant="outline">
              <RefreshCw className="mr-2 h-4 w-4" />
              Try Again
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // No data state (shouldn't happen but defensive)
  if (!data?.result) {
    return (
      <div className="space-y-6">
        <div>
          <h1 className="text-2xl font-bold">Results for {clientName}</h1>
        </div>
        <Card>
          <CardHeader>
            <CardTitle>No Projection Data</CardTitle>
            <CardDescription>
              Unable to calculate projections for this client.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button onClick={() => refetch()}>
              <RefreshCw className="mr-2 h-4 w-4" />
              Calculate Projections
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  const { result, cached } = data;
  const selectedResult = result.strategies[activeStrategy];

  // Transform selected strategy data for display
  const chartData = transformToChartData(selectedResult);
  const metrics = extractSummaryMetrics(selectedResult);

  return (
    <div className="space-y-8">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Results for {clientName}</h1>
          <p className="text-muted-foreground">
            Comparing 4 Roth conversion strategies
            {cached && <span className="ml-2 text-xs">(cached)</span>}
          </p>
        </div>
        <Button
          variant="outline"
          size="sm"
          onClick={() => refetch()}
          title="Recalculate with current client data"
        >
          <RefreshCw className="mr-2 h-4 w-4" />
          Recalculate
        </Button>
      </div>

      {/* Strategy Comparison Table */}
      <section>
        <h2 className="text-lg font-semibold mb-4">Strategy Comparison</h2>
        <StrategyComparisonTable
          result={result}
          selectedStrategy={activeStrategy}
          onStrategySelect={setSelectedStrategy}
        />
      </section>

      {/* Selected Strategy Detail View */}
      <section>
        <h2 className="text-lg font-semibold mb-4">
          {STRATEGY_DEFINITIONS[activeStrategy].name} Strategy Details
        </h2>

        {/* Summary Cards */}
        <div className="mb-6">
          <SummarySection metrics={metrics} />
        </div>

        {/* Wealth Chart */}
        <Card>
          <CardHeader>
            <CardTitle>Wealth Projection</CardTitle>
            <CardDescription>
              Baseline (no conversion) vs {STRATEGY_DEFINITIONS[activeStrategy].name} (Roth conversion)
            </CardDescription>
          </CardHeader>
          <CardContent>
            <WealthChart data={chartData} breakEvenAge={metrics.breakEvenAge} />
          </CardContent>
        </Card>

        {/* Heir Benefit Card (if positive) */}
        {metrics.heirBenefit > 0 && (
          <Card className="mt-6">
            <CardContent className="pt-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-muted-foreground">Benefit to Heirs</p>
                  <p className="text-xl font-semibold text-green-600">
                    +${(metrics.heirBenefit / 100).toLocaleString()}
                  </p>
                </div>
                <p className="text-sm text-muted-foreground max-w-md">
                  Based on heir tax bracket, heirs receive more from the {STRATEGY_DEFINITIONS[activeStrategy].name} strategy
                  due to tax-free Roth distributions.
                </p>
              </div>
            </CardContent>
          </Card>
        )}
      </section>
    </div>
  );
}
```

Update `components/results/index.ts` to export MultiStrategyResults:

```typescript
// Add this export after existing exports
export { MultiStrategyResults } from './multi-strategy-results';
```

Key implementation notes:
- useState for selectedStrategy, defaults to bestStrategy when data loads
- activeStrategy uses nullish coalescing chain for fallback
- Reuses SummarySection and WealthChart from Phase 05
- transformToChartData and extractSummaryMetrics from Phase 05 transforms
- Loading skeleton matches new layout (comparison table + cards + chart)
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile.
Check file exists: `ls components/results/multi-strategy-results.tsx`
Check export: `grep "MultiStrategyResults" components/results/index.ts`
  </verify>
  <done>
MultiStrategyResults container created. Displays comparison table and detail view for selected strategy.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update results page to use multi-strategy</name>
  <files>app/(dashboard)/clients/[id]/results/page.tsx</files>
  <action>
Update `app/(dashboard)/clients/[id]/results/page.tsx` to use MultiStrategyResults instead of ResultsSummary:

```typescript
import { createClient } from '@/lib/supabase/server';
import { notFound } from 'next/navigation';
import { MultiStrategyResults } from '@/components/results';

interface ResultsPageProps {
  params: Promise<{ id: string }>;
}

export default async function ResultsPage({ params }: ResultsPageProps) {
  const { id } = await params;
  const supabase = await createClient();

  // Fetch client name for display (minimal data, projection fetched client-side)
  const { data: client, error } = await supabase
    .from('clients')
    .select('id, name')
    .eq('id', id)
    .single();

  if (error || !client) {
    notFound();
  }

  return (
    <div className="container py-6">
      <MultiStrategyResults clientId={client.id} clientName={client.name} />
    </div>
  );
}

export async function generateMetadata({ params }: ResultsPageProps) {
  const { id } = await params;
  const supabase = await createClient();

  const { data: client } = await supabase
    .from('clients')
    .select('name')
    .eq('id', id)
    .single();

  return {
    title: client ? `Strategy Comparison - ${client.name}` : 'Strategy Comparison',
    description: 'Compare 4 Roth conversion strategies side-by-side',
  };
}
```

Key changes from Phase 05 version:
- Import MultiStrategyResults instead of ResultsSummary
- Title changed to "Strategy Comparison"
- Description updated to reflect multi-strategy
- Rest of structure stays the same
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile.
Check import: `grep "MultiStrategyResults" app/\(dashboard\)/clients/\[id\]/results/page.tsx`
  </verify>
  <done>
Results page updated to use MultiStrategyResults. Shows 4-strategy comparison on load.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete multi-strategy comparison with:
- API endpoint calculating all 4 strategies
- Comparison table showing metrics for Conservative, Moderate, Aggressive, IRMAA-Safe
- BEST badge on winning strategy column (highlighted in blue)
- Strategy selection buttons to switch detail view
- Summary cards and wealth chart for selected strategy
  </what-built>
  <how-to-verify>
1. Go to https://rothc-lime.vercel.app
2. Log in and navigate to an existing client
3. Click "View Results" button
4. On /clients/[id]/results page, verify:
   - Loading skeleton shows briefly while calculating
   - Comparison table appears with 4 strategy columns
   - One column has green "BEST" badge and light blue background
   - 5 metric rows: Ending Wealth, Tax Savings, Breakeven Age, IRMAA Surcharges, Heir Benefit
   - "Select" buttons below each strategy
5. Click a different strategy's "Select" button:
   - Button changes to "Selected"
   - Detail view below updates to show that strategy's name
   - Summary cards and chart update with that strategy's data
6. Click "Recalculate" button - should refresh all data
7. Verify mobile/tablet:
   - Table should scroll horizontally on narrow screens
   - Metric column should be visible while scrolling
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the multi-strategy comparison</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes with no errors
2. API endpoint returns MultiStrategyResult with all 4 strategies
3. Comparison table displays 5 metrics for all 4 strategies
4. Best strategy has BEST badge and highlighted column
5. Clicking strategy selection updates detail view
6. Summary cards and chart show selected strategy's data
7. Loading and error states display correctly
</verification>

<success_criteria>
- useMultiStrategy hook fetches from /api/clients/[id]/multi-strategy
- API runs runMultiStrategySimulation server-side
- MultiStrategyResults shows comparison table at top
- Best strategy pre-selected on initial load
- Strategy selection is stateful (persists during session)
- Detail view updates when strategy changes
- Title shows selected strategy name
- Heir benefit card only shows if positive
</success_criteria>

<output>
After completion, create `.planning/phases/06-multi-strategy-comparison/06-03-SUMMARY.md`
</output>
